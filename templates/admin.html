<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="/static/tailwind.js"></script>
    <link rel="stylesheet" href="/static/chat.css">
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#4F46E5",
                        "background-light": "#F8FAFC", 
                        "background-dark": "#111827", 
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.75rem",
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
        #sidebar {
            transition: width 0.3s ease-in-out;
        }
        #sidebar.collapsed {
            width: 4rem;
        }
        #sidebar .hist-toggle-btn {
            position: relative;
            right: -30px;
            transition: position 3s ease-in-out;
            border-bottom: 1px solid gainsboro;
        }
        #sidebar.collapsed .hist-toggle-btn {
            transition: right 0.3s ease-in-out;
            right: 0;
        }
        

        #sidebar.collapsed .logo-text {
            display: none;
        }
        .inner-bar-cont{
            border-bottom: 1px solid gainsboro;
        }
        
        #sidebar.collapsed .inner-bar-cont{
            justify-content: center;
            border-bottom: none;
        }
        #sidebar.collapsed .nav-section h3 {
            opacity: 0;
        }
        #sidebar.collapsed .nav-text {
            display: none;
            opacity: 0;
            transition: opacity 1s ease;
        }
        #sidebar.collapsed .user-section {
            flex-direction: column;
            gap: 0.75rem;
        }
        #sidebar.collapsed .user-text {
            display: none;
        }
        #sidebar.collapsed a[href="#"].nav-link {
            gap: 0;
            justify-content: center;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        /* UI Improvements: Enhanced shadows and hovers */
        .card-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .nav-link {
            transition: background-color 0.2s ease;
        }
        .nav-link:hover {
            background-color: rgba(79, 70, 229, 0.1);
        }
        /* Smooth slide for nav items */
        .nav-section ul {
            transition: margin-left 0.3s ease;
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-gray-900 dark:text-gray-100">
    <div class="flex h-screen">
        <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800/50 border-r border-gray-200 dark:border-gray-700/50 flex flex-col sidebar-transition">
            <div class="flex items-center justify-between mb-8 p-4 inner-bar-cont">
                <div class="flex items-center gap-2 logo-container">
                    <span class="text-2xl ml-3 font-bold text-gray-800  dark:text-white logo-text">Analytix</span>
                </div>
                <button id="toggle-btn" class="hist-toggle-btn p-[6px] rounded-full border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 collapse-toggle">
                    <svg class="w-[18px] h-[18px] text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
            </div>
            <nav class="flex-grow p-2">

                <!-- Analytics section -->
                <div class="mb-6 nav-section">
                    <h3 class="text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider px-4 mb-2">Analytics</h3>
                    <ul>
                        <li class="nav-item" title="Dashboard" >
                            <a class="flex items-center gap-3  rounded-lg bg-gray-100 dark:bg-gray-700/50 text-gray-600 dark:text-white font-semibold tab-link" style="padding: 8px 8px;" href="#" data-tab="dashboard">
                            
                                    <svg class="w-[24px] h-[24px]" viewBox="0 -0.5 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12.5 11.75C12.9142 11.75 13.25 11.4142 13.25 11C13.25 10.5858 12.9142 10.25 12.5 10.25V11.75ZM5.5 10.25C5.08579 10.25 4.75 10.5858 4.75 11C4.75 11.4142 5.08579 11.75 5.5 11.75V10.25ZM12.5 10.25C12.0858 10.25 11.75 10.5858 11.75 11C11.75 11.4142 12.0858 11.75 12.5 11.75V10.25ZM19.5 11.75C19.9142 11.75 20.25 11.4142 20.25 11C20.25 10.5858 19.9142 10.25 19.5 10.25V11.75ZM11.75 11C11.75 11.4142 12.0858 11.75 12.5 11.75C12.9142 11.75 13.25 11.4142 13.25 11H11.75ZM13.25 5C13.25 4.58579 12.9142 4.25 12.5 4.25C12.0858 4.25 11.75 4.58579 11.75 5H13.25ZM6.25 11C6.25 10.5858 5.91421 10.25 5.5 10.25C5.08579 10.25 4.75 10.5858 4.75 11H6.25ZM20.25 11C20.25 10.5858 19.9142 10.25 19.5 10.25C19.0858 10.25 18.75 10.5858 18.75 11H20.25ZM4.75 11C4.75 11.4142 5.08579 11.75 5.5 11.75C5.91421 11.75 6.25 11.4142 6.25 11H4.75ZM12.5 5.75C12.9142 5.75 13.25 5.41421 13.25 5C13.25 4.58579 12.9142 4.25 12.5 4.25V5.75ZM18.75 11C18.75 11.4142 19.0858 11.75 19.5 11.75C19.9142 11.75 20.25 11.4142 20.25 11H18.75ZM12.5 4.25C12.0858 4.25 11.75 4.58579 11.75 5C11.75 5.41421 12.0858 5.75 12.5 5.75V4.25ZM12.5 10.25H5.5V11.75H12.5V10.25ZM12.5 11.75H19.5V10.25H12.5V11.75ZM13.25 11V5H11.75V11H13.25ZM4.75 11V15H6.25V11H4.75ZM4.75 15C4.75 17.6234 6.87665 19.75 9.5 19.75V18.25C7.70507 18.25 6.25 16.7949 6.25 15H4.75ZM9.5 19.75H15.5V18.25H9.5V19.75ZM15.5 19.75C18.1234 19.75 20.25 17.6234 20.25 15H18.75C18.75 16.7949 17.2949 18.25 15.5 18.25V19.75ZM20.25 15V11H18.75V15H20.25ZM6.25 11V9H4.75V11H6.25ZM6.25 9C6.25 7.20507 7.70507 5.75 9.5 5.75V4.25C6.87665 4.25 4.75 6.37665 4.75 9H6.25ZM9.5 5.75H12.5V4.25H9.5V5.75ZM20.25 11V9H18.75V11H20.25ZM20.25 9C20.25 6.37665 18.1234 4.25 15.5 4.25V5.75C17.2949 5.75 18.75 7.20507 18.75 9H20.25ZM15.5 4.25H12.5V5.75H15.5V4.25Z" fill="currentColor"/>
                                        </svg>
                                <span class="nav-text">Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-item" title="Analytics">
                            <a class="flex items-center gap-3  rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700/30 tab-link" style="padding: 11px 12px;" href="#" data-tab="analytics">
                                <svg class="w-[16px] h-[16px]" fill="currentColor"  viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M29.5 7c-1.381 0-2.5 1.12-2.5 2.5 0 0.284 0.058 0.551 0.144 0.805l-6.094 5.247c-0.427-0.341-0.961-0.553-1.55-0.553-0.68 0-1.294 0.273-1.744 0.713l-4.774-2.39c-0.093-1.296-1.162-2.323-2.482-2.323-1.38 0-2.5 1.12-2.5 2.5 0 0.378 0.090 0.732 0.24 1.053l-4.867 5.612c-0.273-0.102-0.564-0.166-0.873-0.166-1.381 0-2.5 1.119-2.5 2.5s1.119 2.5 2.5 2.5c1.381 0 2.5-1.119 2.5-2.5 0-0.332-0.068-0.649-0.186-0.939l4.946-5.685c0.236 0.073 0.48 0.124 0.74 0.124 0.727 0 1.377-0.316 1.834-0.813l4.669 2.341c0.017 1.367 1.127 2.471 2.497 2.471 1.381 0 2.5-1.119 2.5-2.5 0-0.044-0.011-0.086-0.013-0.13l6.503-5.587c0.309 0.137 0.649 0.216 1.010 0.216 1.381 0 2.5-1.119 2.5-2.5s-1.119-2.5-2.5-2.5z"></path>
                                </svg>
                                <span class="nav-text">Analytics</span>
                            </a>
                        </li>
                        <li class="nav-item" title="Insights" >
                            <a class="flex items-center gap-3 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700/30 tab-link" style="padding: 10px 11px;" href="#" data-tab="insights">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                                <span class="nav-text">Insights</span>
                            </a>
                        </li>
                    </ul>
                </div>
            
                <!-- Management section -->
                <div class="nav-section">
                    <h3 class="text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider px-4 mb-2">Management</h3>
                    <ul>
                        <li class="nav-item" title="Sessions" >
                            <a class="flex items-center gap-3 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700/30 tab-link" style="padding: 11px 12px;" href="#" data-tab="sessions">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-4.072A9.863 9.863 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <span class="nav-text">Sessions</span>
                            </a>
                        </li>
                        <li class="nav-item" title="Leads" >
                            <a class="flex items-center gap-3  rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700/30 tab-link" style="padding: 11px 12px;" href="#" data-tab="leads">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                <span class="nav-text">Leads</span>
                            </a>
                        </li>
                        <li class="nav-item" title="Projects" >
                            <a class="flex items-center gap-3  rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700/30 tab-link" style="padding: 11px 12px;" href="#" data-tab="projects">
                                <svg class="w-5 h-5" viewBox="0 0 512 512" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                    <title>project</title>
                                    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                        <g id="Combined-Shape" fill="currentColor" transform="translate(64.000000, 34.346667)">
                                            <path d="M192,7.10542736e-15 L384,110.851252 L384,332.553755 L192,443.405007 L1.42108547e-14,332.553755 L1.42108547e-14,110.851252 L192,7.10542736e-15 Z M42.666,157.654 L42.6666667,307.920144 L170.666,381.82 L170.666,231.555 L42.666,157.654 Z M341.333,157.655 L213.333,231.555 L213.333,381.82 L341.333333,307.920144 L341.333,157.655 Z M192,49.267223 L66.1333333,121.936377 L192,194.605531 L317.866667,121.936377 L192,49.267223 Z"></path>
                                        </g>
                                    </g>
                                </svg>
                                <span class="nav-text">Projects</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            <div class="mt-auto">
                <div class="flex items-center gap-3 p-2 user-profile">
                    <div class="w-10 h-10 rounded-full bg-gray-800 dark:bg-gray-700 flex items-center justify-center font-bold text-white">A</div>
                </div>
            </div>
        </aside>
        <!-- Overlay for more menu when sidebar is collapsed -->
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-0 z-5 transition-opacity duration-300 invisible pointer-events-none"></div>
        <main class="flex-1 p-8 overflow-y-auto">
            <div id="tab-content" >
                <div id="dashboard-tab" class="tab-panel active">
                    <div id="loading-spinner" class="fixed inset-0 bg-white dark:bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
                        <div class="animate-spin rounded-full h-10 w-10 border-[4px] border-gray-900 border-t-transparent"></div>
                    </div>
                    <header class="mb-8 flex justify-between items-start">
                        <div>
                            <h1 class="text-4xl font-bold text-gray-800 dark:text-white">Dashboard</h1>
                            <p class="text-gray-500 dark:text-gray-400">Quick overview of chatbot performance and lead collection</p>
                        </div>
                        
                        <button onclick="loadDashboard()" class="p-2 bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg hover:bg-background-light dark:hover:bg-background-dark transition-colors duration-200" title="Refresh analytics">
                            <svg class="w-5 h-5 text-text-secondary-light dark:text-text-secondary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                    </header>
                
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-8">
                        <!-- Total Leads -->
                        <div class="bg-white dark:bg-gray-800/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-700/50 shadow-sm card-hover">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">Total Leads</span>
                                <div class="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg">
                                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-4xl font-bold text-gray-800 dark:text-white" id="total-leads">0</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Collected this week</p>
                        </div>
                        <!-- High Engagement -->
                        <div class="bg-white dark:bg-gray-800/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-700/50 shadow-sm card-hover">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">High Engagement</span>
                                <div class="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg">
                                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-4xl font-bold text-gray-800 dark:text-white" id="high-engagement">0</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Users with quality conversations</p>
                        </div>
                        <!-- Active Chats -->
                        <div class="bg-white dark:bg-gray-800/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-700/50 shadow-sm card-hover">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">Active Chats</span>
                                <div class="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg">
                                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-4xl font-bold text-gray-800 dark:text-white" id="active-chats">0</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Currently in progress</p>
                        </div>
                        <!-- Avg Response -->
                        <div class="bg-white dark:bg-gray-800/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-700/50 shadow-sm card-hover">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">Avg Response</span>
                                <div class="p-2 bg-gray-100 dark:bg-gray-700/50 rounded-lg">
                                    <svg class="w-6 h-6 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-4xl font-bold text-gray-800 dark:text-white" id="avg-response">0s</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Bot response time</p>
                        </div>
                        <!-- Requested Services -->
                        <div class="bg-white dark:bg-gray-800/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-700/50 shadow-sm card-hover">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">Requested Services</span>
                                <div class="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg">
                                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-4xl font-bold text-gray-800 dark:text-white" id="requested-services">0</p>
                            <p class="flex items-center text-sm text-green-600 dark:text-green-400" id="requested-change">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                </svg>
                                0% vs last period
                            </p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white dark:bg-gray-800/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-700/50 shadow-sm card-hover">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Service Demand Pulse</h2>
                                <span class="text-sm bg-gray-100 dark:bg-gray-700/50 px-3 py-1 rounded-full text-gray-600 dark:text-gray-300" id="service-requests-count">0 requests</span>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Top requests over the last 7 days</p>
                            <div class="bg-gray-100 dark:bg-gray-900/50 p-4 rounded-xl mb-6" id="top-service">
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-medium">Top Service</p>
                                <div class="flex items-center gap-3 mt-2">
                                    <div class="w-10 h-10 bg-gray-800 dark:bg-gray-700 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M16.1266 22.1995C16.7081 22.5979 17.4463 23.0228 18.3121 23.3511C19.9903 23.9874 21.244 24.0245 21.8236 23.9917C23.1167 23.9184 23.2907 23.0987 22.5972 22.0816C21.8054 20.9202 21.0425 19.6077 21.1179 18.1551C22.306 16.3983 23 14.2788 23 12C23 5.92487 18.0751 1 12 1C5.92487 1 1 5.92487 1 12C1 18.0751 5.92487 23 12 23C13.4578 23 14.8513 22.7159 16.1266 22.1995ZM12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C13.3697 21 14.6654 20.6947 15.825 20.1494C16.1635 19.9902 16.5626 20.0332 16.8594 20.261C17.3824 20.6624 18.1239 21.1407 19.0212 21.481C19.4111 21.6288 19.7674 21.7356 20.0856 21.8123C19.7532 21.2051 19.4167 20.4818 19.2616 19.8011C19.1018 19.0998 18.8622 17.8782 19.328 17.2262C20.3808 15.7531 21 13.9503 21 12C21 7.02944 16.9706 3 12 3Z" fill="currentColor"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800 dark:text-white" id="top-service-name">N/A</p>
                                        <p class="flex items-center text-sm text-green-600 dark:text-green-400" id="top-service-change">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                            </svg>
                                            0% vs last week
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-5" id="service-demand-list">
                                <!-- Dynamic service bars will be inserted here -->
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-700/50 shadow-sm card-hover">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Deepest Conversations</h2>
                                <span class="text-sm bg-gray-100 dark:bg-gray-700/50 px-3 py-1 rounded-full text-gray-600 dark:text-gray-300" id="avg-conversation-time">Avg 00m 00s</span>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Longest chats this week</p>
                            <div class="space-y-3" id="deepest-conversations-list">
                                <!-- Dynamic conversation items will be inserted here -->
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-700/50 shadow-sm card-hover">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Hot Leads Radar</h2>
                                <span class="text-sm bg-gray-100 dark:bg-gray-700/50 px-3 py-1 rounded-full text-gray-600 dark:text-gray-300 flex items-center gap-1" id="hot-leads-count">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    0 ready
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Priority leads for follow-up</p>
                            <div class="space-y-3" id="hot-leads-list">
                                <!-- Dynamic hot leads items will be inserted here -->
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div class="bg-white dark:bg-gray-800/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-700/50 shadow-sm card-hover flex flex-col justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">AI Analytics</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Explore conversation trends and AI insights to optimize performance.</p>
                            </div>
                            <a class="self-end text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary tab-link" href="#" data-tab="analytics">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                                </svg>
                            </a>
                        </div>
                        <div class="bg-white dark:bg-gray-800/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-700/50 shadow-sm card-hover flex flex-col justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">All Leads</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">View and manage all collected leads. Export data for your CRM.</p>
                            </div>
                            <a class="self-end text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary tab-link" href="#" data-tab="leads">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                                </svg>
                            </a>
                        </div>
                        <div class="bg-white dark:bg-gray-800/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-700/50 shadow-sm card-hover flex flex-col justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Chat Sessions</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Review full conversational history and user interactions.</p>
                            </div>
                            <a class="self-end text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary tab-link" href="#" data-tab="sessions">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>

                
                
                <script>
                    async function loadDashboard() {
                        const spinner = document.getElementById('loading-spinner');
                        spinner.classList.remove('hidden');
                        try {
                            const response = await fetch('/api/dashboard');
                            if (!response.ok) {
                                throw new Error('Failed to fetch dashboard data');
                            }
                            const data = await response.json();
                
                            // Update metrics
                            document.getElementById('total-leads').textContent = data.total_leads;
                            document.getElementById('high-engagement').textContent = data.high_engagement;
                            document.getElementById('active-chats').textContent = data.active_chats;
                            document.getElementById('avg-response').textContent = data.avg_response;
                            document.getElementById('requested-services').textContent = data.requested_services;
                
                            // Requested services change
                            const reqChangeEl = document.getElementById('requested-change');
                            const isPositive = data.requested_change.includes('+') || data.requested_change === '100%';
                            const reqPathD = isPositive ? 'M5 10l7-7m0 0l7 7m-7-7v18' : 'M19 14l-7 7m0 0l-7-7m7 7V3';
                            const colorClass = isPositive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                            reqChangeEl.innerHTML = `
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${reqPathD}"></path>
                                </svg>
                                ${data.requested_change} vs last period
                            `;
                            reqChangeEl.className = `flex items-center text-sm ${colorClass}`;
                
                            // Service Demand Pulse
                            document.getElementById('service-requests-count').textContent = `${data.requested_services} requests`;
                
                            // Top Service
                            const topServiceEl = document.getElementById('top-service-name');
                            topServiceEl.textContent = data.top_service.name;
                            const topChangeEl = document.getElementById('top-service-change');
                            const topIsPositive = data.top_service.change.includes('+');
                            const topPathD = topIsPositive ? 'M5 10l7-7m0 0l7 7m-7-7v18' : 'M19 14l-7 7m0 0l-7-7m7 7V3';
                            const topColor = topIsPositive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                            topChangeEl.innerHTML = `
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${topPathD}"></path>
                                </svg>
                                ${data.top_service.change} vs last week
                            `;
                            topChangeEl.className = `flex items-center text-sm ${topColor}`;
                
                            // Service Demand List
                            const serviceListEl = document.getElementById('service-demand-list');
                            serviceListEl.innerHTML = '';
                            data.service_demand.forEach(service => {
                                const isPositive = service.change.includes('+');
                                const icon = isPositive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                                const changeText = isPositive ? service.change : service.change.replace('-', '-');
                                const barWidth = Math.min((service.count / data.requested_services) * 100, 100);
                                const barHtml = `
                                    <div class="text-sm">
                                        <div class="flex justify-between items-center mb-1 text-gray-600 dark:text-gray-300">
                                            <span>${service.name}</span>
                                            <div><span class="font-semibold text-gray-800 dark:text-white">${service.count}</span> <span class="${icon} ml-2">${changeText}</span></div>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                            <div class="bg-gray-800 dark:bg-gray-300 h-1.5 rounded-full" style="width: ${barWidth}%"></div>
                                        </div>
                                    </div>
                                `;
                                serviceListEl.insertAdjacentHTML('beforeend', barHtml);
                            });
                
                            // Deepest Conversations
                            document.getElementById('avg-conversation-time').textContent = `Avg ${data.avg_conversation_time}`;
                
                            const deepestListEl = document.getElementById('deepest-conversations-list');
                            deepestListEl.innerHTML = '';
                            data.deepest_conversations.forEach(conv => {
                                const changeColor = conv.change_color;
                                const convPathD = conv.change_icon === 'arrow_upward' ? 'M5 10l7-7m0 0l7 7m-7-7v18' : 'M19 14l-7 7m0 0l-7-7m7 7V3';
                                const convHtml = `
                                    <div class="bg-gray-100/50 dark:bg-gray-900/40 p-3 rounded-lg flex justify-between items-center">
                                        <div>
                                            <p class="font-semibold text-gray-800 dark:text-white">${conv.name}</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">${conv.company}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold text-gray-800 dark:text-white">${conv.duration}</p>
                                            <p class="flex items-center justify-end text-sm ${changeColor}">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${convPathD}"></path>
                                                </svg>
                                                ${conv.change}
                                            </p>
                                        </div>
                                    </div>
                                `;
                                deepestListEl.insertAdjacentHTML('beforeend', convHtml);
                            });
                
                            // Hot Leads Radar
                            document.getElementById('hot-leads-count').innerHTML = `
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                ${data.hot_leads_count} ready
                            `;
                
                            const hotLeadsListEl = document.getElementById('hot-leads-list');
                            hotLeadsListEl.innerHTML = '';
                            data.hot_leads.forEach(lead => {
                                const hotLeadHtml = `
                                    <div class="bg-gray-100/50 dark:bg-gray-900/40 p-3 rounded-lg">
                                        <div class="flex justify-between items-start">
                                            <div class="flex items-center gap-2">
                                                <p class="font-semibold text-gray-800 dark:text-white">${lead.name}</p>
                                                <span class="text-xs bg-white dark:bg-gray-700/50 px-2 py-0.5 rounded-full border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300">${lead.priority}</span>
                                            </div>
                                            <span class="text-sm text-gray-500 dark:text-gray-400">${lead.time}</span>
                                        </div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${lead.company}</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">${lead.service}</p>
                                    </div>
                                `;
                                hotLeadsListEl.insertAdjacentHTML('beforeend', hotLeadHtml);
                            });
                
                        } catch (error) {
                            console.error(" ");
                        } finally {
                            spinner.classList.add('hidden');
                        }
                    }

                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', loadDashboard);
                    } else {
                        loadDashboard();
                    }

                </script>
                <div id="analytics-tab" class="tab-panel hidden">
                    <div id="analytics-spinner" class="flex items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-10 w-10 border-[4px] border-gray-900 border-t-transparent"></div>
                        <span class="ml-3 text-text-secondary-light dark:text-text-secondary-dark"></span>
                    </div>
                    <div id="analytics-content" style="display: none;">
                        <header class="flex items-center justify-between mb-8">
                            <div>
                                <h1 class="text-3xl font-bold">AI Chatbot Intelligence</h1>
                                <p class="text-text-secondary-light dark:text-text-secondary-dark mt-1">Insights from conversational AI analysis</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="refresh-btn" class="p-2 bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg hover:bg-background-light dark:hover:bg-background-dark transition-colors duration-200" title="Refresh analytics">
                                    <svg class="w-5 h-5 text-text-secondary-light dark:text-text-secondary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                </button>
                                <div class="relative">
                                    <button id="period-toggle" class="flex items-center space-x-2 px-4 py-2 bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg text-sm font-medium" aria-expanded="false">
                                        <span id="period-text">This Week</span>
                                        <svg id="chevron-icon" class="w-4 h-4 text-text-secondary-light dark:text-text-secondary-dark transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="period-dropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg shadow-lg opacity-0 invisible transition-all duration-200 z-10">
                                        <button class="period-option w-full text-left px-4 py-2 text-sm hover:bg-background-light dark:hover:bg-background-dark rounded-t-lg" data-period="week">This Week</button>
                                        <button class="period-option w-full text-left px-4 py-2 text-sm hover:bg-background-light dark:hover:bg-background-dark" data-period="month">This Month</button>
                                        <button class="period-option w-full text-left px-4 py-2 text-sm hover:bg-background-light dark:hover:bg-background-dark" data-period="year">This Year</button>
                                        <button class="period-option w-full text-left px-4 py-2 text-sm hover:bg-background-light dark:hover:bg-background-dark rounded-b-lg" data-period="all">All Time</button>
                                    </div>
                                </div>
                            </div>
                        </header>
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-6">
                            <!-- Highly Engaged Users -->
                            <div class="bg-card-light dark:bg-card-dark p-6 rounded-lg border border-border-light dark:border-border-dark">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-xs font-semibold text-text-secondary-light dark:text-text-secondary-dark uppercase tracking-wider">Highly Engaged Users</p>
                                        <p class="text-4xl font-bold mt-2" id="highly-engaged-count">0</p>
                                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark mt-1" id="highly-engaged-pct">0% of all conversations</p>
                                    </div>
                                    <div class="bg-blue-100 dark:bg-blue-900/50 p-2 rounded-lg">
                                        <svg class="w-6 h-6 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <!-- AI Enriched Leads -->
                            <div class="bg-card-light dark:bg-card-dark p-6 rounded-lg border border-border-light dark:border-border-dark">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-xs font-semibold text-text-secondary-light dark:text-text-secondary-dark uppercase tracking-wider">AI Enriched Leads</p>
                                        <p class="text-4xl font-bold mt-2" id="ai-enriched-leads">0</p>
                                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark mt-1">Deep research completed</p>
                                    </div>
                                    <div class="bg-blue-100 dark:bg-blue-900/50 p-2 rounded-lg">
                                        <svg class="w-6 h-6 text-blue-500 dark:text-blue-400" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M11.7086 1.53214C10.9786 1.05676 10.078 0.917375 9.27255 1.04467C8.46803 1.17183 7.62325 1.5904 7.12591 2.39445C6.9332 2.70601 6.81024 3.04646 6.7559 3.40767C5.97312 3.35525 5.18086 3.59264 4.58547 4.08919C3.98255 4.59201 3.59741 5.34432 3.59741 6.25684C3.59741 6.55614 3.63851 6.86315 3.72008 7.17654C3.42298 7.23942 3.13697 7.34918 2.86932 7.50027C1.98542 7.99927 1.36438 8.90663 1.11913 9.88841C0.869371 10.8882 0.989124 12.0467 1.70052 13.0391C2.0609 13.5419 2.54903 13.9691 3.1623 14.305C3.01053 14.5081 2.88229 14.7271 2.77811 14.9565C2.35249 15.8935 2.32044 17.0038 2.64559 17.98C2.97535 18.9701 3.69756 19.8871 4.83624 20.3254C5.57833 20.6111 6.42615 20.6665 7.35551 20.4749C7.39798 20.9494 7.52745 21.3806 7.74983 21.7577C8.22598 22.5651 9.0236 22.9458 9.80541 22.9947C10.5523 23.0414 11.3758 22.778 12 22.2458C12.6242 22.778 13.4477 23.0414 14.1946 22.9947C14.9764 22.9458 15.774 22.5651 16.2502 21.7577C16.4725 21.3806 16.602 20.9494 16.6445 20.4749C17.5738 20.6665 18.4217 20.6111 19.1638 20.3254C20.3024 19.8871 21.0246 18.9701 21.3544 17.98C21.6796 17.0038 21.6475 15.8935 21.2219 14.9565C21.1177 14.7271 20.9895 14.5081 20.8377 14.305C21.451 13.9691 21.9391 13.5419 22.2995 13.0391C23.0109 12.0467 23.1306 10.8882 22.8809 9.88841C22.6356 8.90663 22.0146 7.99927 21.1307 7.50027C20.863 7.34918 20.577 7.23942 20.2799 7.17654C20.3615 6.86315 20.4026 6.55614 20.4026 6.25684C20.4026 5.34432 20.0175 4.59201 19.4145 4.08919C18.8191 3.59264 18.0269 3.35525 17.2441 3.40767C17.1898 3.04646 17.0668 2.70601 16.8741 2.39445C16.3767 1.5904 15.532 1.17183 14.7274 1.04467C13.922 0.917375 13.0214 1.05676 12.2914 1.53214C11.9861 1.73097 12.0139 1.73097 11.7086 1.53214ZM13.0033 20.0518L13.0033 17.5288C13.0045 17.0494 13.1133 16.3457 13.3939 15.7998C13.6573 15.2872 13.9946 15.0268 14.5082 15.0268C15.0623 15.0268 15.5115 14.5773 15.5115 14.0227C15.5115 13.4682 15.0623 13.0186 14.5082 13.0186C13.9202 13.0186 13.4216 13.16 13.0033 13.3894V12.5084C13.0045 12.029 13.1133 11.3254 13.3939 10.7794C13.6573 10.2668 13.9946 10.0064 14.5082 10.0064C15.0623 10.0064 15.5115 9.55688 15.5115 9.00234C15.5115 8.4478 15.0623 7.99826 14.5082 7.99826C13.9202 7.99826 13.4216 8.13957 13.0033 8.36902L13.0033 3.97532C13.005 3.57853 13.1671 3.35779 13.3859 3.21528C13.6436 3.04746 14.0284 2.96723 14.4144 3.02824C14.8013 3.08939 15.0539 3.26704 15.1679 3.45142C15.2603 3.60078 15.3726 3.9329 15.091 4.59054C14.9015 5.03294 15.0524 5.54766 15.4507 5.8175C15.849 6.08734 16.3825 6.03639 16.7226 5.69604C17.0903 5.32811 17.7563 5.32032 18.1299 5.63189C18.2795 5.75662 18.396 5.94564 18.396 6.25684C18.396 6.59422 18.2548 7.14633 17.705 7.91672C17.4235 8.31116 17.4637 8.85055 17.8006 9.19878C18.1375 9.54701 18.6749 9.60465 19.0779 9.33577C19.5101 9.04741 19.8566 9.08664 20.1448 9.24934C20.4837 9.44063 20.8032 9.85112 20.9342 10.3755C21.0607 10.8818 20.9923 11.4176 20.669 11.8686C20.3466 12.3184 19.6765 12.8121 18.3565 13.0323C17.8683 13.1137 17.5124 13.5392 17.5182 14.0344C17.5239 14.5296 17.8896 14.9467 18.3795 15.0167C18.8812 15.0884 19.207 15.3732 19.3952 15.7874C19.5966 16.231 19.6273 16.8151 19.4508 17.345C19.2789 17.861 18.9351 18.2619 18.4434 18.4511C17.9498 18.6411 17.1399 18.6809 15.9267 18.129C15.5761 17.9695 15.1653 18.025 14.8694 18.2716C14.5735 18.5183 14.4448 18.9127 14.5382 19.2866C14.6621 19.7827 14.8668 20.9406 14.0694 20.9905C13.5184 21.0249 13.0062 20.6055 13.0033 20.0518ZM10.9967 3.97532C10.995 3.57853 10.8329 3.35779 10.6141 3.21528C10.3564 3.04746 9.97157 2.96723 9.58558 3.02824C9.19869 3.08939 8.94611 3.26704 8.83207 3.45142C8.73968 3.60078 8.62739 3.9329 8.90901 4.59054C9.09846 5.03294 8.94757 5.54766 8.54931 5.8175C8.15105 6.08734 7.61747 6.03639 7.27739 5.69604C6.90975 5.32811 6.24365 5.32032 5.87006 5.63189C5.72051 5.75662 5.604 5.94564 5.604 6.25684C5.604 6.59422 5.74515 7.14633 6.29501 7.91672C6.57653 8.31116 6.53629 8.85055 6.19937 9.19878C5.86246 9.54701 5.32505 9.60465 4.92206 9.33577C4.48987 9.04741 4.1434 9.08664 3.8552 9.24934C3.51634 9.44063 3.19679 9.85112 3.06581 10.3755C2.93933 10.8818 3.0077 11.4176 3.33095 11.8686C3.65342 12.3184 4.32349 12.8121 5.64353 13.0323C6.13166 13.1137 6.48757 13.5392 6.48182 14.0344C6.47607 14.5296 6.11037 14.9467 5.62048 15.0167C5.1188 15.0884 4.793 15.3732 4.60484 15.7874C4.40339 16.231 4.37273 16.8151 4.54922 17.345C4.7211 17.861 5.06489 18.2619 5.55656 18.4511C6.05021 18.6411 6.86015 18.6809 8.0733 18.129C8.42388 17.9695 8.83474 18.025 9.13063 18.2716C9.42652 18.5183 9.5552 18.9127 9.4618 19.2866C9.33788 19.7827 9.13324 20.9406 9.93058 20.9905C10.4816 21.0249 10.9938 20.6055 10.9967 20.0518L10.9967 20.0472V17.5292C10.9955 17.0498 10.8868 16.3459 10.6061 15.7998C10.3427 15.2872 10.0054 15.0268 9.49176 15.0268C8.93765 15.0268 8.48846 14.5773 8.48846 14.0227C8.48846 13.4682 8.93765 13.0186 9.49176 13.0186C10.0798 13.0186 10.5784 13.16 10.9967 13.3894V12.5088C10.9955 12.0294 10.8868 11.3255 10.6061 10.7794C10.3427 10.2668 10.0054 10.0064 9.49176 10.0064C8.93765 10.0064 8.48846 9.55688 8.48846 9.00234C8.48846 8.4478 8.93765 7.99826 9.49176 7.99826C10.0798 7.99826 10.5784 8.13957 10.9967 8.36902L10.9967 3.97532Z" fill="currentColor"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <!-- Buying Signals -->
                            <div class="bg-card-light dark:bg-card-dark p-6 rounded-lg border border-border-light dark:border-border-dark">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-xs font-semibold text-text-secondary-light dark:text-text-secondary-dark uppercase tracking-wider">Buying Signals</p>
                                        <p class="text-4xl font-bold mt-2" id="buying-signals">0</p>
                                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark mt-1">High-intent indicators detected</p>
                                    </div>
                                    <div class="bg-blue-100 dark:bg-blue-900/50 p-2 rounded-lg">
                                        <svg class="w-6 h-6 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <!-- Avg Chat Duration -->
                            <div class="bg-card-light dark:bg-card-dark p-6 rounded-lg border border-border-light dark:border-border-dark">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-xs font-semibold text-text-secondary-light dark:text-text-secondary-dark uppercase tracking-wider">Avg Chat Duration</p>
                                        <p class="text-4xl font-bold mt-2" id="avg-chat-duration">0m 0s</p>
                                        <p class="text-sm mt-1" id="avg-change-pct">0% vs last week</p>
                                    </div>
                                    <div class="bg-blue-100 dark:bg-blue-900/50 p-2 rounded-lg">
                                        <svg class="w-6 h-6 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-card-light dark:bg-card-dark p-6 rounded-lg border border-border-light dark:border-border-dark space-y-6">
                                <div class="flex items-center space-x-4">
                                    <div class="p-3 bg-background-light dark:bg-background-dark rounded-lg">
                                        <svg class="w-6 h-6 text-text-primary-light dark:text-text-primary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold">Engagement Quality</h3>
                                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">How users interact with AI</p>
                                    </div>
                                </div>
                                <div class="space-y-5">
                                    <div class="border-b border-border-light dark:border-border-dark pb-5">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-medium text-sm">Highly Engaged</span>
                                            <span class="font-semibold text-sm" id="eng-highly-count">0</span>
                                        </div>
                                        <div class="w-full bg-background-light dark:bg-zinc-700 rounded-full h-2">
                                            <div class="bg-gray-800 dark:bg-gray-200 h-2 rounded-full transition-all duration-300" id="eng-highly-bar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-2">Shared details, asked questions, long chats</p>
                                    </div>
                                    <div class="border-b border-border-light dark:border-border-dark pb-5">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-medium text-sm">Engaged</span>
                                            <span class="font-semibold text-sm" id="eng-engaged-count">0</span>
                                        </div>
                                        <div class="w-full bg-background-light dark:bg-zinc-700 rounded-full h-2">
                                            <div class="bg-gray-600 dark:bg-gray-400 h-2 rounded-full transition-all duration-300" id="eng-engaged-bar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-2">Good conversation flow, moderate detail</p>
                                    </div>
                                    <div class="border-b border-border-light dark:border-border-dark pb-5">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-medium text-sm">Neutral</span>
                                            <span class="font-semibold text-sm" id="eng-neutral-count">0</span>
                                        </div>
                                        <div class="w-full bg-background-light dark:bg-zinc-700 rounded-full h-2">
                                            <div class="bg-gray-400 dark:bg-gray-600 h-2 rounded-full transition-all duration-300" id="eng-neutral-bar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-2">Basic responses, minimal engagement</p>
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-medium text-sm">Disengaged</span>
                                            <span class="font-semibold text-sm" id="eng-disengaged-count">0</span>
                                        </div>
                                        <div class="w-full bg-background-light dark:bg-zinc-700 rounded-full h-2">
                                            <div class="bg-gray-200 dark:bg-gray-800 h-2 rounded-full transition-all duration-300" id="eng-disengaged-bar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-2">Brief interaction, no follow-through</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-card-light dark:bg-card-dark p-6 rounded-lg border border-border-light dark:border-border-dark">
                                <div class="flex items-center space-x-4 mb-6">
                                    <div class="p-3 bg-background-light dark:bg-background-dark rounded-lg">
                                        
                                        <svg class="w-6 h-6 text-text-primary-light dark:text-text-primary-dark" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M20.9423 3.05768C23.4117 5.52701 21.4099 11.5324 16.4712 16.4711C11.5326 21.4097 5.5272 23.4115 3.05787 20.9422C0.588547 18.4728 2.59033 12.4675 7.52899 7.5288C12.4676 2.59014 18.473 0.588345 20.9423 3.05768ZM3.05768 3.05782C0.588349 5.52715 2.59013 11.5325 7.52879 16.4712C12.4674 21.4099 18.4728 23.4117 20.9421 20.9423C23.4115 18.473 21.4097 12.4676 16.471 7.52894C11.5324 2.59028 5.527 0.588485 3.05768 3.05782Z" stroke="currentColor" stroke-width="1.5"/>
                                            <path d="M14.5 12C14.5 13.3807 13.3807 14.5 12 14.5C10.6193 14.5 9.5 13.3807 9.5 12C9.5 10.6193 10.6193 9.5 12 9.5C13.3807 9.5 14.5 10.6193 14.5 12Z" stroke="currentColor" stroke-width="1.5"/>
                                            </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold">Sentiment Analysis</h3>
                                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">AI-detected user mood</p>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <div class="flex justify-between items-center text-sm mb-1">
                                            <span>excited</span>
                                            <span id="sent-excited">0 (0%)</span>
                                        </div>
                                        <div class="w-full bg-background-light dark:bg-zinc-700 rounded-full h-2">
                                            <div class="bg-gray-900 dark:bg-gray-200 h-2 rounded-full transition-all duration-300" id="sent-excited-bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center text-sm mb-1">
                                            <span>positive</span>
                                            <span id="sent-positive">0 (0%)</span>
                                        </div>
                                        <div class="w-full bg-background-light dark:bg-zinc-700 rounded-full h-2">
                                            <div class="bg-gray-800 dark:bg-gray-300 h-2 rounded-full transition-all duration-300" id="sent-positive-bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center text-sm mb-1">
                                            <span>friendly</span>
                                            <span id="sent-friendly">0 (0%)</span>
                                        </div>
                                        <div class="w-full bg-background-light dark:bg-zinc-700 rounded-full h-2">
                                            <div class="bg-gray-600 dark:bg-gray-500 h-2 rounded-full transition-all duration-300" id="sent-friendly-bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center text-sm mb-1">
                                            <span>neutral</span>
                                            <span id="sent-neutral">0 (0%)</span>
                                        </div>
                                        <div class="w-full bg-background-light dark:bg-zinc-700 rounded-full h-2">
                                            <div class="bg-gray-400 dark:bg-gray-700 h-2 rounded-full transition-all duration-300" id="sent-neutral-bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center text-sm mb-1">
                                            <span>confused</span>
                                            <span id="sent-confused">0 (0%)</span>
                                        </div>
                                        <div class="w-full bg-background-light dark:bg-zinc-700 rounded-full h-2">
                                            <div class="bg-gray-300 dark:bg-gray-500 h-2 rounded-full transition-all duration-300" id="sent-confused-bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-6 bg-background-light dark:bg-background-dark p-4 rounded-lg text-center text-sm text-text-secondary-light dark:text-text-secondary-dark">
                                    <span class="font-semibold text-text-primary-light dark:text-text-primary-dark" id="positive-sentiment">0% positive sentiment</span> 
                                </div>
                            </div>
                            <div class="bg-card-light dark:bg-card-dark p-6 rounded-lg border border-border-light dark:border-border-dark space-y-6">
                                <div class="flex items-center space-x-4">
                                    <div class="p-3 bg-background-light dark:bg-background-dark rounded-lg">
                                        <svg class="w-6 h-6 text-text-primary-light dark:text-text-primary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
                                            <circle cx="12" cy="12" r="6" stroke-width="2"></circle>
                                            <circle cx="12" cy="12" r="2" stroke-width="2"></circle>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold">Genuine Interest Detection</h3>
                                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Intent analysis by AI</p>
                                    </div>
                                </div>
                                <div class="space-y-5">
                                    <div class="border-b border-border-light dark:border-border-dark pb-5">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-medium text-sm">High Intent</span>
                                            <span class="font-semibold text-sm" id="interest-high-count">0</span>
                                        </div>
                                        <div class="w-full bg-background-light dark:bg-zinc-700 rounded-full h-2">
                                            <div class="bg-gray-800 dark:bg-gray-200 h-2 rounded-full transition-all duration-300" id="interest-high-bar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-2">Budget, timeline, requirements shared</p>
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-medium text-sm">Medium Intent</span>
                                            <span class="font-semibold text-sm" id="interest-medium-count">0</span>
                                        </div>
                                        <div class="w-full bg-background-light dark:bg-zinc-700 rounded-full h-2">
                                            <div class="bg-gray-600 dark:bg-gray-400 h-2 rounded-full transition-all duration-300" id="interest-medium-bar" style="width: 0%"></div>
                                        </div>
                                        <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-2">Specific questions, engaged chat</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-card-light dark:bg-card-dark p-6 rounded-lg border border-border-light dark:border-border-dark">
                                <div class="flex items-center space-x-4 mb-6">
                                    <div class="p-3 bg-background-light dark:bg-background-dark rounded-lg">
                                        <svg class="w-6 h-6 text-text-primary-light dark:text-text-primary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold">AI Research Insights</h3>
                                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Background research completed</p>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center pb-4 border-b border-border-light dark:border-border-dark">
                                        <div>
                                            <p class="font-medium">Total Enriched</p>
                                            <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Leads with AI research</p>
                                        </div>
                                        <p class="text-2xl font-bold" id="research-total">0</p>
                                    </div>
                                    <div class="flex justify-between items-center pb-4 border-b border-border-light dark:border-border-dark">
                                        <div>
                                            <p class="font-medium">Company Insights</p>
                                            <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Key business details found</p>
                                        </div>
                                        <p class="text-2xl font-bold" id="research-company">0</p>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-medium">Decision Makers</p>
                                            <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Key contacts identified</p>
                                        </div>
                                        <p class="text-2xl font-bold" id="research-decision">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                    let currentPeriod = 'week'; // Default
                
                    // Period toggle functionality
                    const toggleBtn = document.getElementById('period-toggle');
                    const dropdown = document.getElementById('period-dropdown');
                    const periodText = document.getElementById('period-text');
                    const chevronIcon = document.getElementById('chevron-icon');
                
                    toggleBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                        toggleBtn.setAttribute('aria-expanded', !isExpanded);
                        dropdown.style.opacity = isExpanded ? '0' : '1';
                        dropdown.style.visibility = isExpanded ? 'hidden' : 'visible';
                        chevronIcon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
                    });
                
                    document.querySelectorAll('.period-option').forEach(option => {
                        option.addEventListener('click', (e) => {
                            e.stopPropagation();
                            currentPeriod = e.target.dataset.period;
                            periodText.textContent = e.target.textContent;
                            toggleBtn.setAttribute('aria-expanded', 'false');
                            dropdown.style.opacity = '0';
                            dropdown.style.visibility = 'hidden';
                            chevronIcon.style.transform = 'rotate(0deg)';
                            fetchAnalytics(currentPeriod);
                        });
                    });
                
                    // Refresh button functionality
                    const refreshBtn = document.getElementById('refresh-btn');
                    refreshBtn.addEventListener('click', () => {
                        fetchAnalytics(currentPeriod);
                    });
                
                    // Close dropdown on outside click
                    document.addEventListener('click', () => {
                        toggleBtn.setAttribute('aria-expanded', 'false');
                        dropdown.style.opacity = '0';
                        dropdown.style.visibility = 'hidden';
                        chevronIcon.style.transform = 'rotate(0deg)';
                    });
                
                    async function fetchAnalytics(period = 'week') {
                        const spinner = document.getElementById('analytics-spinner');
                        const content = document.getElementById('analytics-content');
                        spinner.style.display = 'flex';
                        content.style.display = 'none';
                
                        try {
                            const url = `/analytics?period=${period}`;
                            const response = await fetch(url);
                            if (!response.ok) {
                                throw new Error('Failed to fetch analytics');
                            }
                            const data = await response.json();
                
                            // Update comparison text based on period
                            const comparisonTexts = {
                                week: 'vs last week',
                                month: 'vs last month',
                                year: 'vs last year',
                                all: 'since inception'
                            };
                            const compText = comparisonTexts[period] || 'vs last week';
                            const changeEl = document.getElementById('avg-change-pct');
                            const pct = data.summary.avg_change_pct || 0;
                            if (period === 'all') {
                                changeEl.textContent = `${compText}`;
                                changeEl.className = 'text-sm mt-1 text-text-secondary-light dark:text-text-secondary-dark';
                            } else {
                                changeEl.textContent = `${pct > 0 ? '+' : ''}${pct}% ${compText}`;
                                changeEl.className = `text-sm mt-1 ${pct >= 0 ? 'text-green-600 dark:text-green-500' : 'text-red-600 dark:text-red-500'}`;
                            }
                
                            // Populate Summary
                            document.getElementById('highly-engaged-count').textContent = data.summary.highly_engaged_users || 0;
                            document.getElementById('highly-engaged-pct').textContent = `${data.summary.highly_engaged_pct}% of all conversations`;
                            document.getElementById('ai-enriched-leads').textContent = data.summary.ai_enriched_leads || 0;
                            document.getElementById('buying-signals').textContent = data.summary.buying_signals || 0;
                            document.getElementById('avg-chat-duration').textContent = data.summary.avg_chat_duration || '0m 0s';
                
                            // Populate Engagement Quality
                            document.getElementById('eng-highly-count').textContent = data.engagement_quality.highly_engaged.count || 0;
                            document.getElementById('eng-highly-bar').style.width = `${data.engagement_quality.highly_engaged.bar_pct || 0}%`;
                            document.getElementById('eng-engaged-count').textContent = data.engagement_quality.engaged.count || 0;
                            document.getElementById('eng-engaged-bar').style.width = `${data.engagement_quality.engaged.bar_pct || 0}%`;
                            document.getElementById('eng-neutral-count').textContent = data.engagement_quality.neutral.count || 0;
                            document.getElementById('eng-neutral-bar').style.width = `${data.engagement_quality.neutral.bar_pct || 0}%`;
                            document.getElementById('eng-disengaged-count').textContent = data.engagement_quality.disengaged.count || 0;
                            document.getElementById('eng-disengaged-bar').style.width = `${data.engagement_quality.disengaged.bar_pct || 0}%`;
                
                            // Populate Sentiment Analysis
                            document.getElementById('sent-excited').textContent = `${data.sentiment_analysis.excited.count || 0} (${data.sentiment_analysis.excited.pct || 0}%)`;
                            document.getElementById('sent-excited-bar').style.width = `${data.sentiment_analysis.excited.bar_pct || 0}%`;
                            document.getElementById('sent-positive').textContent = `${data.sentiment_analysis.positive.count || 0} (${data.sentiment_analysis.positive.pct || 0}%)`;
                            document.getElementById('sent-positive-bar').style.width = `${data.sentiment_analysis.positive.bar_pct || 0}%`;
                            document.getElementById('sent-neutral').textContent = `${data.sentiment_analysis.neutral.count || 0} (${data.sentiment_analysis.neutral.pct || 0}%)`;
                            document.getElementById('sent-neutral-bar').style.width = `${data.sentiment_analysis.neutral.bar_pct || 0}%`;
                            document.getElementById('sent-confused').textContent = `${data.sentiment_analysis.confused.count || 0} (${data.sentiment_analysis.confused.pct || 0}%)`;
                            document.getElementById('sent-confused-bar').style.width = `${data.sentiment_analysis.confused.bar_pct || 0}%`;
                            document.getElementById('sent-friendly').textContent = `${data.sentiment_analysis.friendly.count || 0} (${data.sentiment_analysis.friendly.pct || 0}%)`;
                            document.getElementById('sent-friendly-bar').style.width = `${data.sentiment_analysis.friendly.bar_pct || 0}%`;
                            document.getElementById('positive-sentiment').textContent = `${data.sentiment_analysis.positive_pct || 0}% positive sentiment`;
                
                            // Populate Genuine Interest
                            document.getElementById('interest-high-count').textContent = data.genuine_interest_detection.high_intent.count || 0;
                            document.getElementById('interest-high-bar').style.width = `${data.genuine_interest_detection.high_intent.bar_pct || 0}%`;
                            document.getElementById('interest-medium-count').textContent = data.genuine_interest_detection.medium_intent.count || 0;
                            document.getElementById('interest-medium-bar').style.width = `${data.genuine_interest_detection.medium_intent.bar_pct || 0}%`;
                
                            // Populate AI Research Insights
                            document.getElementById('research-total').textContent = data.ai_research_insights.total_enriched || 0;
                            document.getElementById('research-company').textContent = data.ai_research_insights.company_insights || 0;
                            document.getElementById('research-decision').textContent = data.ai_research_insights.decision_makers || 0;
                
                            spinner.style.display = 'none';
                            content.style.display = 'block';
                        } catch (error) {
                            spinner.style.display = 'none';
                            content.style.display = 'block';
                        }
                    }

                    document.addEventListener('DOMContentLoaded', () => fetchAnalytics(currentPeriod));
                </script>

        <div id="insights-tab" class="tab-panel hidden">

            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 md:mb-6 gap-3">
                <div>
                <div class="flex items-center gap-2 mb-1">
                <svg class=" text-gray-800" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M11.7086 1.53214C10.9786 1.05676 10.078 0.917375 9.27255 1.04467C8.46803 1.17183 7.62325 1.5904 7.12591 2.39445C6.9332 2.70601 6.81024 3.04646 6.7559 3.40767C5.97312 3.35525 5.18086 3.59264 4.58547 4.08919C3.98255 4.59201 3.59741 5.34432 3.59741 6.25684C3.59741 6.55614 3.63851 6.86315 3.72008 7.17654C3.42298 7.23942 3.13697 7.34918 2.86932 7.50027C1.98542 7.99927 1.36438 8.90663 1.11913 9.88841C0.869371 10.8882 0.989124 12.0467 1.70052 13.0391C2.0609 13.5419 2.54903 13.9691 3.1623 14.305C3.01053 14.5081 2.88229 14.7271 2.77811 14.9565C2.35249 15.8935 2.32044 17.0038 2.64559 17.98C2.97535 18.9701 3.69756 19.8871 4.83624 20.3254C5.57833 20.6111 6.42615 20.6665 7.35551 20.4749C7.39798 20.9494 7.52745 21.3806 7.74983 21.7577C8.22598 22.5651 9.0236 22.9458 9.80541 22.9947C10.5523 23.0414 11.3758 22.778 12 22.2458C12.6242 22.778 13.4477 23.0414 14.1946 22.9947C14.9764 22.9458 15.774 22.5651 16.2502 21.7577C16.4725 21.3806 16.602 20.9494 16.6445 20.4749C17.5738 20.6665 18.4217 20.6111 19.1638 20.3254C20.3024 19.8871 21.0246 18.9701 21.3544 17.98C21.6796 17.0038 21.6475 15.8935 21.2219 14.9565C21.1177 14.7271 20.9895 14.5081 20.8377 14.305C21.451 13.9691 21.9391 13.5419 22.2995 13.0391C23.0109 12.0467 23.1306 10.8882 22.8809 9.88841C22.6356 8.90663 22.0146 7.99927 21.1307 7.50027C20.863 7.34918 20.577 7.23942 20.2799 7.17654C20.3615 6.86315 20.4026 6.55614 20.4026 6.25684C20.4026 5.34432 20.0175 4.59201 19.4145 4.08919C18.8191 3.59264 18.0269 3.35525 17.2441 3.40767C17.1898 3.04646 17.0668 2.70601 16.8741 2.39445C16.3767 1.5904 15.532 1.17183 14.7274 1.04467C13.922 0.917375 13.0214 1.05676 12.2914 1.53214C11.9861 1.73097 12.0139 1.73097 11.7086 1.53214ZM13.0033 20.0518L13.0033 17.5288C13.0045 17.0494 13.1133 16.3457 13.3939 15.7998C13.6573 15.2872 13.9946 15.0268 14.5082 15.0268C15.0623 15.0268 15.5115 14.5773 15.5115 14.0227C15.5115 13.4682 15.0623 13.0186 14.5082 13.0186C13.9202 13.0186 13.4216 13.16 13.0033 13.3894V12.5084C13.0045 12.029 13.1133 11.3254 13.3939 10.7794C13.6573 10.2668 13.9946 10.0064 14.5082 10.0064C15.0623 10.0064 15.5115 9.55688 15.5115 9.00234C15.5115 8.4478 15.0623 7.99826 14.5082 7.99826C13.9202 7.99826 13.4216 8.13957 13.0033 8.36902L13.0033 3.97532C13.005 3.57853 13.1671 3.35779 13.3859 3.21528C13.6436 3.04746 14.0284 2.96723 14.4144 3.02824C14.8013 3.08939 15.0539 3.26704 15.1679 3.45142C15.2603 3.60078 15.3726 3.9329 15.091 4.59054C14.9015 5.03294 15.0524 5.54766 15.4507 5.8175C15.849 6.08734 16.3825 6.03639 16.7226 5.69604C17.0903 5.32811 17.7563 5.32032 18.1299 5.63189C18.2795 5.75662 18.396 5.94564 18.396 6.25684C18.396 6.59422 18.2548 7.14633 17.705 7.91672C17.4235 8.31116 17.4637 8.85055 17.8006 9.19878C18.1375 9.54701 18.6749 9.60465 19.0779 9.33577C19.5101 9.04741 19.8566 9.08664 20.1448 9.24934C20.4837 9.44063 20.8032 9.85112 20.9342 10.3755C21.0607 10.8818 20.9923 11.4176 20.669 11.8686C20.3466 12.3184 19.6765 12.8121 18.3565 13.0323C17.8683 13.1137 17.5124 13.5392 17.5182 14.0344C17.5239 14.5296 17.8896 14.9467 18.3795 15.0167C18.8812 15.0884 19.207 15.3732 19.3952 15.7874C19.5966 16.231 19.6273 16.8151 19.4508 17.345C19.2789 17.861 18.9351 18.2619 18.4434 18.4511C17.9498 18.6411 17.1399 18.6809 15.9267 18.129C15.5761 17.9695 15.1653 18.025 14.8694 18.2716C14.5735 18.5183 14.4448 18.9127 14.5382 19.2866C14.6621 19.7827 14.8668 20.9406 14.0694 20.9905C13.5184 21.0249 13.0062 20.6055 13.0033 20.0518ZM10.9967 3.97532C10.995 3.57853 10.8329 3.35779 10.6141 3.21528C10.3564 3.04746 9.97157 2.96723 9.58558 3.02824C9.19869 3.08939 8.94611 3.26704 8.83207 3.45142C8.73968 3.60078 8.62739 3.9329 8.90901 4.59054C9.09846 5.03294 8.94757 5.54766 8.54931 5.8175C8.15105 6.08734 7.61747 6.03639 7.27739 5.69604C6.90975 5.32811 6.24365 5.32032 5.87006 5.63189C5.72051 5.75662 5.604 5.94564 5.604 6.25684C5.604 6.59422 5.74515 7.14633 6.29501 7.91672C6.57653 8.31116 6.53629 8.85055 6.19937 9.19878C5.86246 9.54701 5.32505 9.60465 4.92206 9.33577C4.48987 9.04741 4.1434 9.08664 3.8552 9.24934C3.51634 9.44063 3.19679 9.85112 3.06581 10.3755C2.93933 10.8818 3.0077 11.4176 3.33095 11.8686C3.65342 12.3184 4.32349 12.8121 5.64353 13.0323C6.13166 13.1137 6.48757 13.5392 6.48182 14.0344C6.47607 14.5296 6.11037 14.9467 5.62048 15.0167C5.1188 15.0884 4.793 15.3732 4.60484 15.7874C4.40339 16.231 4.37273 16.8151 4.54922 17.345C4.7211 17.861 5.06489 18.2619 5.55656 18.4511C6.05021 18.6411 6.86015 18.6809 8.0733 18.129C8.42388 17.9695 8.83474 18.025 9.13063 18.2716C9.42652 18.5183 9.5552 18.9127 9.4618 19.2866C9.33788 19.7827 9.13324 20.9406 9.93058 20.9905C10.4816 21.0249 10.9938 20.6055 10.9967 20.0518L10.9967 20.0472V17.5292C10.9955 17.0498 10.8868 16.3459 10.6061 15.7998C10.3427 15.2872 10.0054 15.0268 9.49176 15.0268C8.93765 15.0268 8.48846 14.5773 8.48846 14.0227C8.48846 13.4682 8.93765 13.0186 9.49176 13.0186C10.0798 13.0186 10.5784 13.16 10.9967 13.3894V12.5088C10.9955 12.0294 10.8868 11.3255 10.6061 10.7794C10.3427 10.2668 10.0054 10.0064 9.49176 10.0064C8.93765 10.0064 8.48846 9.55688 8.48846 9.00234C8.48846 8.4478 8.93765 7.99826 9.49176 7.99826C10.0798 7.99826 10.5784 8.13957 10.9967 8.36902L10.9967 3.97532Z" fill="currentColor"/>
                </svg>
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">Knowledge Base</h1>
                </div>
                <p class="text-xs md:text-sm text-gray-500 max-w-md">Configure rules, profiles, and alignments to power your customer chatbot with tailored knowledge.</p>
                </div>
                <div class="block">
                    <div class="unsaved-indicator hidden relative" id="unsaved-dot">
                        <div class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    </div>
                    <button id="sync-btn" class="bg-gray-800 text-white font-medium py-2 px-4 rounded-full flex items-center gap-1.5 shadow-sm hover:shadow-md hover:bg-gray-700 transition-all duration-200 text-sm">
                        <svg fill="currentColor" width="20" height="20" viewBox="-4 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg">
                            <title>sync</title>
                            <path d="M17.594 16h2.031c0-1.813-0.688-3.531-1.75-4.844h-0.031c-0.781-0.938-1.719-1.656-2.844-2.125-0.031 0-0.063-0.031-0.063-0.031-0.188-0.063-0.375-0.188-0.563-0.25-0.063 0-0.094-0.031-0.156-0.031-0.156-0.063-0.375-0.094-0.531-0.125-0.063-0.031-0.156-0.063-0.219-0.063-0.188-0.031-0.344-0.063-0.531-0.094h-0.188c-0.219-0.031-0.469-0.031-0.688-0.031-1.563-0.031-3.094 0.438-4.406 1.344-0.531 0.375-1.344 0.25-1.688-0.281-0.375-0.531-0.219-1.281 0.313-1.656 1.688-1.188 3.656-1.813 5.688-1.813 0.031 0 0.031-0.031 0.031-0.031 0.063 0 0.094 0.031 0.125 0.031 0.281 0 0.563 0 0.813 0.031 0.125 0 0.219 0.031 0.344 0.031 0.125 0.031 0.281 0.031 0.438 0.063 0.063 0 0.125 0.031 0.188 0.031 0.094 0.031 0.25 0.094 0.375 0.125 0.188 0.031 0.406 0.094 0.594 0.156 0.094 0.031 0.188 0.063 0.25 0.094 0.25 0.063 0.5 0.156 0.719 0.25 0.063 0 0.094 0.031 0.125 0.031 1.438 0.625 2.719 1.563 3.75 2.813 0 0.031 0.031 0.031 0.031 0.063 0.156 0.188 0.313 0.406 0.438 0.594 0.031 0 0.031 0.031 0.031 0.063 1.125 1.625 1.813 3.531 1.813 5.656h1.969l-3.188 4.781zM0 16l3.188-4.813 3.219 4.813h-2.031c0 1.781 0.656 3.406 1.719 4.719 0.031 0.031 0.031 0.063 0.063 0.094 0.156 0.188 0.313 0.375 0.469 0.531v0.031c0.5 0.5 1.094 0.938 1.719 1.281 0.031 0 0.031 0.031 0.031 0.031 0.188 0.094 0.406 0.188 0.594 0.25 0.031 0.031 0.094 0.063 0.125 0.063 0.156 0.063 0.313 0.125 0.5 0.188 0.063 0.031 0.125 0.063 0.219 0.063 0.125 0.063 0.313 0.094 0.469 0.125 0.094 0.031 0.188 0.031 0.281 0.063 0.156 0.031 0.313 0.063 0.469 0.063 0.094 0.031 0.156 0.031 0.25 0.031 0.188 0.031 0.438 0.031 0.625 0.031 1.594 0.031 3.125-0.438 4.438-1.375 0.531-0.344 1.344-0.188 1.688 0.344 0.375 0.531 0.219 1.281-0.313 1.656-1.688 1.188-3.656 1.813-5.688 1.813-0.344 0-0.688-0.031-1.031-0.063-0.063 0-0.125-0.031-0.188-0.031-0.188-0.031-0.344-0.031-0.531-0.063-0.063-0.031-0.125-0.031-0.156-0.031-0.125-0.031-0.313-0.063-0.438-0.094-0.188-0.063-0.375-0.094-0.563-0.156-0.094-0.031-0.188-0.063-0.313-0.094-0.188-0.063-0.438-0.156-0.656-0.25-0.063 0-0.125-0.031-0.156-0.063-0.25-0.125-0.531-0.25-0.75-0.375-0.031 0-0.063-0.031-0.063-0.031-0.844-0.438-1.563-1-2.25-1.688 0-0.031-0.031-0.031-0.031-0.063-0.188-0.188-0.406-0.406-0.594-0.625-0.063-0.031-0.094-0.125-0.125-0.188l-0.375-0.469c0-0.031-0.031-0.031-0.031-0.063-1.125-1.594-1.813-3.531-1.813-5.656h-1.969z"></path>
                            </svg>
                                    Save & Sync
                                </button>
                    
                </div>
                </header>
                <div class="border-b border-gray-200 mb-4 md:mb-6">
                <nav aria-label="Tabs" class="flex flex-col sm:flex-row space-y-1.5 sm:space-y-0 sm:space-x-6 overflow-x-auto pb-1">
                <a class="inner-tab-link py-2 px-3 sm:px-1 border-b-2 font-medium text-xs text-gray-900 border-gray-800 active-tab" data-tab="overview" href="#">Overview</a>
                <a class="inner-tab-link py-2 px-3 sm:px-1 border-b-2 font-medium text-xs text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="rules" href="#">Rules & Restrictions</a>
                <a class="inner-tab-link py-2 px-3 sm:px-1 border-b-2 font-medium text-xs text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="documents" href="#">Documents</a>
                <a class="inner-tab-link py-2 px-3 sm:px-1 border-b-2 font-medium text-xs text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="profile" href="#">Company Profile</a>
                <a class="inner-tab-link py-2 px-3 sm:px-1 border-b-2 font-medium text-xs text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="alignments" href="#">Alignments</a>
                <a class="inner-tab-link py-2 px-3 sm:px-1 border-b-2 font-medium text-xs text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="templates" href="#">Template and Tasks</a>
                <a class="inner-tab-link py-2 px-3 sm:px-1 border-b-2 font-medium text-xs text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="consultants" href="#">Manage Consultants</a>
                </nav>
                </div>
                
                <!-- Overview Tab -->
                <div id="overview" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Sources</h3>
                <p class="text-3xl font-bold text-gray-900 mt-1 sources-count">0</p>
                <p class="text-xs text-gray-500 mt-1">Documents and pages indexed</p>
                </div>
                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Storage Used</h3>
                <p class="text-3xl font-bold text-gray-900 mt-1 storage-used">0 GB</p>
                <p class="text-xs text-gray-500 mt-1">Across all sources</p>
                </div>
                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Last Sync</h3>
                <p class="text-3xl font-bold text-gray-900 mt-1 last-sync">Never</p>
                <p class="text-xs text-gray-500 mt-1">To customer chatbot</p>
                </div>
                </div>
                </div>
                
                <!-- Rules & Restrictions Tab -->
                <div id="rules" class="tab-content hidden">
                    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Rules & Restrictions</h2>
                        <p class="text-gray-500 dark:text-gray-400 mb-8">Define AI behavior and set safety boundaries for optimal performance.</p>
                        <div class="space-y-10">
                            <!-- Name Input -->
                            <div>
                                <div class="flex items-center gap-3 mb-3">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M16.1267 22.1995C16.7081 22.5979 17.4463 23.0228 18.3121 23.3511C19.9904 23.9874 21.244 24.0245 21.8236 23.9917C23.1167 23.9184 23.2907 23.0987 22.5972 22.0816C21.8054 20.9202 21.0425 19.6077 21.1179 18.1551C22.306 16.3983 23 14.2788 23 12C23 5.92487 18.0751 1 12 1C5.92488 1 1.00001 5.92487 1.00001 12C1.00001 18.0751 5.92488 23 12 23C13.4578 23 14.8513 22.7159 16.1267 22.1995ZM12 3C7.02945 3 3.00001 7.02944 3.00001 12C3.00001 16.9706 7.02945 21 12 21C13.3697 21 14.6654 20.6947 15.825 20.1494C16.1635 19.9902 16.5626 20.0332 16.8594 20.261C17.3824 20.6624 18.1239 21.1407 19.0212 21.481C19.4111 21.6288 19.7674 21.7356 20.0856 21.8123C19.7533 21.2051 19.4167 20.4818 19.2616 19.8011C19.1018 19.0998 18.8622 17.8782 19.3281 17.2262C20.3808 15.7531 21 13.9503 21 12C21 7.02944 16.9706 3 12 3ZM12 14C9.76094 14 8.4671 15.169 8.10992 16.3009C7.94372 16.8276 7.38202 17.1198 6.85534 16.9536C6.32866 16.7874 6.03643 16.2257 6.20263 15.6991C6.61242 14.4005 7.59994 13.2939 8.9933 12.6382C8.37493 11.934 8.00001 11.0108 8.00001 10C8.00001 7.79086 9.79087 6 12 6C14.2092 6 16 7.79086 16 10C16 11.0108 15.6251 11.934 15.0067 12.6382C16.4001 13.2939 17.3876 14.4005 17.7974 15.6991C17.9636 16.2257 17.6714 16.7874 17.1447 16.9536C16.618 17.1198 16.0563 16.8276 15.8901 16.3009C15.5329 15.169 14.2391 14 12 14ZM10 10C10 8.89543 10.8954 8 12 8C13.1046 8 14 8.89543 14 10C14 11.1046 13.1046 12 12 12C10.8954 12 10 11.1046 10 10Z" fill="currentColor"/>
                                </svg>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 " for="name-text">Bot Name</label>
                                </div>
                                <input id="name-text" type="text" class="p-3 focus:outline-none border border-gray-300 block w-full rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-300     transition duration-200" placeholder="Eg. Sofia">
                                
                            </div>
                            <!-- Behavioral Guidelines -->
                            <div>
                                <div class="flex items-center gap-3 mb-3">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9 6C9 6.39397 9.0776 6.78407 9.22836 7.14805C9.37913 7.51203 9.6001 7.84274 9.87868 8.12132C10.1573 8.3999 10.488 8.62087 10.852 8.77164C11.2159 8.9224 11.606 9 12 9C12.394 9 12.7841 8.9224 13.1481 8.77164C13.512 8.62087 13.8427 8.3999 14.1213 8.12132C14.3999 7.84274 14.6209 7.51203 14.7716 7.14805C14.9224 6.78407 15 6.39396 15 6C15 5.60603 14.9224 5.21593 14.7716 4.85195C14.6209 4.48797 14.3999 4.15725 14.1213 3.87868C13.8427 3.6001 13.512 3.37912 13.148 3.22836C12.7841 3.0776 12.394 3 12 3C11.606 3 11.2159 3.0776 10.8519 3.22836C10.488 3.37913 10.1573 3.6001 9.87868 3.87868C9.6001 4.15726 9.37912 4.48797 9.22836 4.85195C9.0776 5.21593 9 5.60604 9 6L9 6Z" stroke-width="2" stroke=" currentColor"/>
                                        <path d="M4.43781 13.9015C4.09663 14.0985 3.79758 14.3607 3.55775 14.6733C3.31792 14.9858 3.142 15.3426 3.04004 15.7231C2.93807 16.1037 2.91206 16.5006 2.96348 16.8912C3.0149 17.2818 3.14275 17.6584 3.33974 17.9996C3.53672 18.3408 3.79897 18.6398 4.11153 18.8796C4.42408 19.1195 4.78081 19.2954 5.16136 19.3974C5.5419 19.4993 5.9388 19.5253 6.32939 19.4739C6.71999 19.4225 7.09663 19.2946 7.43781 19.0977C7.779 18.9007 8.07804 18.6384 8.31787 18.3259C8.5577 18.0133 8.73362 17.6566 8.83559 17.276C8.93756 16.8955 8.96357 16.4986 8.91215 16.108C8.86072 15.7174 8.73287 15.3408 8.53589 14.9996C8.33891 14.6584 8.07665 14.3594 7.7641 14.1195C7.45154 13.8797 7.09481 13.7038 6.71427 13.6018C6.33373 13.4998 5.93683 13.4738 5.54623 13.5252C5.15564 13.5767 4.779 13.7045 4.43781 13.9015L4.43781 13.9015Z" stroke-width="2" stroke=" currentColor"/>
                                        <path d="M19.5622 13.9015C19.9034 14.0985 20.2024 14.3607 20.4422 14.6733C20.6821 14.9859 20.858 15.3426 20.96 15.7231C21.0619 16.1037 21.0879 16.5006 21.0365 16.8912C20.9851 17.2818 20.8572 17.6584 20.6603 17.9996C20.4633 18.3408 20.201 18.6398 19.8885 18.8796C19.5759 19.1195 19.2192 19.2954 18.8386 19.3974C18.4581 19.4993 18.0612 19.5253 17.6706 19.4739C17.28 19.4225 16.9034 19.2946 16.5622 19.0977C16.221 18.9007 15.922 18.6384 15.6821 18.3259C15.4423 18.0133 15.2664 17.6566 15.1644 17.276C15.0624 16.8955 15.0364 16.4986 15.0879 16.108C15.1393 15.7174 15.2671 15.3408 15.4641 14.9996C15.6611 14.6584 15.9234 14.3594 16.2359 14.1195C16.5485 13.8797 16.9052 13.7038 17.2857 13.6018C17.6663 13.4998 18.0632 13.4738 18.4538 13.5252C18.8444 13.5767 19.221 13.7045 19.5622 13.9015L19.5622 13.9015Z" stroke-width="2" stroke=" currentColor"/>
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M9.00254 6.12533C9.0008 6.08372 8.99993 6.04203 8.99993 6.0003C8.99993 5.65294 9.06026 5.30857 9.17787 4.98247C9.03301 5.03346 8.8894 5.08843 8.74719 5.14733C7.71592 5.5745 6.77889 6.2006 5.98959 6.9899C5.20029 7.7792 4.57419 8.71623 4.14702 9.7475C3.71986 10.7788 3.5 11.8841 3.5 13.0003C3.5 13.5265 3.54885 14.0502 3.64523 14.5648C3.86884 14.2999 4.13691 14.0755 4.43774 13.9018C4.47388 13.8809 4.51042 13.8609 4.54733 13.8415C4.51586 13.5628 4.5 13.2819 4.5 13.0003C4.5 12.0154 4.69399 11.0401 5.0709 10.1302C5.44781 9.22024 6.00026 8.39345 6.6967 7.69701C7.36051 7.03319 8.14275 6.5002 9.00254 6.12533ZM14.9973 6.12528C15.8572 6.50014 16.6395 7.03315 17.3033 7.697C17.9997 8.39344 18.5522 9.22023 18.9291 10.1302C19.306 11.0401 19.5 12.0154 19.5 13.0003C19.5 13.282 19.4841 13.5628 19.4527 13.8416C19.4895 13.8609 19.526 13.881 19.5621 13.9018C19.863 14.0755 20.1311 14.3 20.3547 14.565C20.4511 14.0503 20.5 13.5265 20.5 13.0003C20.5 11.8841 20.2801 10.7788 19.853 9.74749C19.4258 8.71622 18.7997 7.77919 18.0104 6.98989C17.2211 6.2006 16.2841 5.57449 15.2528 5.14733C15.1105 5.0884 14.9669 5.03342 14.822 4.98242C14.9396 5.30854 14.9999 5.65292 14.9999 6.0003C14.9999 6.04201 14.9991 6.08368 14.9973 6.12528ZM17.533 19.4529C17.1916 19.3917 16.8631 19.2717 16.5621 19.098C16.5261 19.0772 16.4906 19.0556 16.4555 19.0334C15.9665 19.3945 15.4343 19.6957 14.8701 19.9294C13.9602 20.3063 12.9849 20.5003 12 20.5003C11.0151 20.5003 10.0398 20.3063 9.12988 19.9294C8.56568 19.6957 8.03345 19.3945 7.54443 19.0334C7.50935 19.0556 7.47378 19.0772 7.43775 19.098C7.13681 19.2717 6.80829 19.3917 6.46694 19.4528C7.14728 20.0362 7.91668 20.5093 8.74719 20.8533C9.77846 21.2804 10.8838 21.5003 12 21.5003C13.1162 21.5003 14.2215 21.2804 15.2528 20.8533C16.0833 20.5093 16.8527 20.0362 17.533 19.4529Z" stroke-width="1" stroke=" currentColor"/>
                                        </svg>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="behavioral-guidelines">Behavioral Guidelines</label>
                                </div>
                                <textarea id="rules-text" class="p-3 focus:outline-none border block w-full rounded-md border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-300     transition duration-200" name="behavioral-guidelines" placeholder="E.g., Maintain a professional, concise, and helpful demeanor." rows="4"></textarea>
                            </div>
                            <!-- Banned Topics / PHI -->
                            <div>
                                <div class="flex items-center gap-3 mb-3">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 7.75V13" stroke=" currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M21.08 8.58003V15.42C21.08 16.54 20.48 17.58 19.51 18.15L13.57 21.58C12.6 22.14 11.4 22.14 10.42 21.58L4.47998 18.15C3.50998 17.59 2.90997 16.55 2.90997 15.42V8.58003C2.90997 7.46003 3.50998 6.41999 4.47998 5.84999L10.42 2.42C11.39 1.86 12.59 1.86 13.57 2.42L19.51 5.84999C20.48 6.41999 21.08 7.45003 21.08 8.58003Z" stroke=" currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 16.2V16.2999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="banned-topics">Banned Topics / PHI</label>
                                </div>
                                <textarea id="banned-text" class="p-3 focus:outline-none border block w-full rounded-md border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-300     transition duration-200" name="banned-topics" placeholder="E.g., Avoid discussing internal roadmaps, personal data, or PHI." rows="4"></textarea>
                            </div>
                            <!-- Tone & Style -->
                            <div>
                                <div class="flex items-center gap-3 mb-3">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 22C12.5523 22 13 21.5523 13 21C13 20.4477 12.5523 20 12 20V22ZM12.4453 4.01216C12.9968 4.04235 13.4683 3.61979 13.4985 3.06833C13.5287 2.51687 13.1061 2.04535 12.5547 2.01515L12.4453 4.01216ZM11.7627 9.23726L11.0556 8.53015L11.7627 9.23726ZM17.411 3.58902L18.1181 4.29613L17.411 3.58902ZM9 15L8.01005 14.8586C7.96411 15.1802 8.07723 15.504 8.3134 15.727C8.54957 15.9501 8.87936 16.0445 9.19778 15.9802L9 15ZM9.04745 14.6678L8.0575 14.5264L8.0575 14.5264L9.04745 14.6678ZM9.48793 14.9016L9.29015 13.9213L9.48793 14.9016ZM12.8012 13.7247L12.2287 12.9048H12.2287L12.8012 13.7247ZM11.564 14.3882L11.9302 15.3187H11.9302L11.564 14.3882ZM10.1791 10.9786L9.34943 10.4203V10.4203L10.1791 10.9786ZM9.49029 12.3561L8.54586 12.0274V12.0274L9.49029 12.3561ZM16.7071 4.29289C16.3166 3.90237 15.6834 3.90237 15.2929 4.29289C14.9024 4.68342 14.9024 5.31658 15.2929 5.70711L16.7071 4.29289ZM18.1213 8.53553C18.5118 8.92606 19.145 8.92606 19.5355 8.53553C19.9261 8.14501 19.9261 7.51184 19.5355 7.12132L18.1213 8.53553ZM16 16C15.4477 16 15 16.4477 15 17C15 17.5523 15.4477 18 16 18V16ZM21.88 10.8011C21.7701 10.2598 21.2423 9.91012 20.701 10.02C20.1598 10.1299 19.8101 10.6577 19.92 11.1989L21.88 10.8011ZM12 20C7.58172 20 4 16.4183 4 12H2C2 17.5228 6.47715 22 12 22V20ZM4 12C4 7.58172 7.58172 4 12 4V2C6.47715 2 2 6.47715 2 12H4ZM12 4C12.1495 4 12.298 4.00409 12.4453 4.01216L12.5547 2.01515C12.371 2.00509 12.186 2 12 2V4ZM12.4698 9.94436L18.1181 4.29613L16.7039 2.88191L11.0556 8.53015L12.4698 9.94436ZM19.5323 5.71034L13.6703 11.5723L15.0845 12.9865L20.9465 7.12455L19.5323 5.71034ZM9.98995 15.1414L10.0374 14.8093L8.0575 14.5264L8.01005 14.8586L9.98995 15.1414ZM9.29015 13.9213L8.80222 14.0198L9.19778 15.9802L9.68571 15.8818L9.29015 13.9213ZM13.6703 11.5723C12.8844 12.3582 12.5736 12.664 12.2287 12.9048L13.3737 14.5447C13.8964 14.1797 14.3472 13.7239 15.0845 12.9865L13.6703 11.5723ZM9.68571 15.8818C10.7079 15.6755 11.3371 15.5522 11.9302 15.3187L11.1977 13.4577C10.8064 13.6118 10.3796 13.7015 9.29015 13.9213L9.68571 15.8818ZM12.2287 12.9048C11.9079 13.1288 11.5618 13.3144 11.1977 13.4577L11.9302 15.3187C12.44 15.1181 12.9245 14.8583 13.3737 14.5447L12.2287 12.9048ZM11.0556 8.53015C10.243 9.34283 9.74031 9.83942 9.34943 10.4203L11.0087 11.5369C11.2665 11.1538 11.6034 10.8108 12.4698 9.94436L11.0556 8.53015ZM10.0374 14.8093C10.2107 13.5963 10.2829 13.121 10.4347 12.6848L8.54586 12.0274C8.31572 12.6886 8.22004 13.3887 8.0575 14.5264L10.0374 14.8093ZM9.34943 10.4203C9.01364 10.9192 8.74356 11.4594 8.54586 12.0274L10.4347 12.6848C10.5759 12.2791 10.7688 11.8933 11.0087 11.5369L9.34943 10.4203ZM19.5323 4.29613C19.9228 4.68665 19.9228 5.31981 19.5323 5.71034L20.9465 7.12455C22.1181 5.95298 22.1181 4.05348 20.9465 2.88191L19.5323 4.29613ZM20.9465 2.88191C19.7749 1.71034 17.8754 1.71034 16.7039 2.88191L18.1181 4.29613C18.5086 3.9056 19.1418 3.9056 19.5323 4.29613L20.9465 2.88191ZM15.2929 5.70711L18.1213 8.53553L19.5355 7.12132L16.7071 4.29289L15.2929 5.70711ZM20 12C20 14.2091 18.2091 16 16 16V18C19.3137 18 22 15.3137 22 12H20ZM19.92 11.1989C19.9723 11.4569 20 11.7247 20 12H22C22 11.5903 21.9588 11.1893 21.88 10.8011L19.92 11.1989Z" fill="currentColor"/>
                                        </svg>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="tone-style">Tone & Style</label>
                                </div>
                                <textarea id="profile-text" class="focus:outline-none border p-3  block w-full rounded-md border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-300  transition duration-200" name="tone-style" placeholder="E.g., Adopt a friendly, confident, and succinct tone." rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Company Profile Tab -->
                <div id="profile" class="tab-content hidden">
                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <div class="flex items-center gap-3 mb-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor"/>
                    </svg>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="budget-options">Company Profile</label>
                </div>
                <textarea id="company-text"  class="w-full h-48 p-3 border border-gray-300 rounded-md bg-white text-gray-900 resize-vertical focus:outline-none   focus:ring-gray-800 placeholder-gray-300 text-sm" placeholder="Describe your company, mission, values, and key details (e.g., history, services, unique selling points)..."></textarea>
                <div class="mt-2 text-xs text-gray-500">Tip: This helps the chatbot provide contextually relevant responses.</div>
                </div>
                </div>

                
                <div id="documents" class="tab-content hidden">
                    <section class="bg-white dark:bg-slate-900 p-6 rounded-xl shadow-sm mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Upload documents</h2>
                                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Add PDFs, Markdown, CSV, or plain text files.</p>
                            </div>
                            <button id="uploadBtn" class="bg-slate-900 dark:bg-slate-200 text-white dark:text-slate-900 font-semibold text-sm py-2 px-4 rounded-full flex items-center hover:bg-slate-700 dark:hover:bg-white">
                                <span class="material-symbols-outlined mr-2 text-lg">upload</span>
                                Upload
                            </button>
                        </div>
                        <div id="dropZone" class="flex justify-center rounded-lg border border-dashed border-slate-300 dark:border-slate-700 px-6 py-10 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                            <div class="text-center">
                                <span class="material-symbols-outlined text-4xl text-slate-400 mb-2 block">cloud_upload</span>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Drag & drop files here or click to select.</p>
                                <input type="file" id="fileInput" accept=".pdf,.md,.csv,.txt" multiple class="hidden">
                            </div>
                        </div>
                        <div id="uploadProgress" class="mt-4 hidden">
                            <div class="bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="uploadStatus" class="text-sm text-slate-500 dark:text-slate-400 mt-1"></p>
                        </div>
                    </section>
                
                    <section class="bg-white dark:bg-slate-900 p-6 rounded-xl shadow-sm">
                        <div class="mb-4">
                            <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Sources</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Manage and view the current knowledge sources.</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="filesTable" class="min-w-full">
                                <thead class="border-b border-slate-200 dark:border-slate-700">
                                    <tr>
                                        <th class="py-3.5 pl-6 pr-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" scope="col">Name</th>
                                        <th class="px-3 py-3.5 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" scope="col">Type</th>
                                        <th class="px-3 py-3.5 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" scope="col">Size</th>
                                        <th class="px-3 py-3.5 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" scope="col">Status</th>
                                        <th class="px-3 py-3.5 text-left text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400" scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-slate-900 divide-y divide-slate-200 dark:divide-slate-800">
                                    <!-- Populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div id="noFiles" class="text-center py-8 text-slate-500 dark:text-slate-400 hidden">
                            <span class="material-symbols-outlined text-4xl block mb-2">folder_open</span>
                            <p>No files uploaded yet.</p>
                        </div>
                    </section>
                
                    <script>
                        // Drag & Drop and Upload Logic
                        const dropZone = document.getElementById('dropZone');
                        const fileInput = document.getElementById('fileInput');
                        const uploadBtn = document.getElementById('uploadBtn');
                        const uploadProgress = document.getElementById('uploadProgress');
                        const progressBar = uploadProgress.querySelector('div[style*="width"]');
                        const uploadStatus = document.getElementById('uploadStatus');
                
                        // Drag events
                        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                            dropZone.addEventListener(eventName, preventDefaults, false);
                        });
                
                        function preventDefaults(e) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                
                        ['dragenter', 'dragover'].forEach(eventName => {
                            dropZone.addEventListener(eventName, () => dropZone.classList.add('bg-slate-50', 'dark:bg-slate-800'), false);
                        });
                
                        ['dragleave', 'drop'].forEach(eventName => {
                            dropZone.addEventListener(eventName, () => dropZone.classList.remove('bg-slate-50', 'dark:bg-slate-800'), false);
                        });
                
                        dropZone.addEventListener('drop', handleDrop, false);
                        uploadBtn.addEventListener('click', () => fileInput.click());
                        fileInput.addEventListener('change', handleFiles);
                
                        function handleDrop(e) {
                            const dt = e.dataTransfer;
                            const files = dt.files;
                            handleFiles({ target: { files } });
                        }
                
                        async function handleFiles(e) {
                            const files = Array.from(e.target.files || e.target.files);
                            if (files.length === 0) return;
                
                            uploadProgress.classList.remove('hidden');
                            uploadStatus.textContent = `Uploading ${files.length} file(s)...`;
                
                            for (let i = 0; i < files.length; i++) {
                                const file = files[i];
                                const formData = new FormData();
                                formData.append('file', file);
                
                                try {
                                    const response = await fetch('/upload', {
                                        method: 'POST',
                                        body: formData
                                    });
                                    if (!response.ok) {
                                        const error = await response.json();
                                        throw new Error(error.detail || 'Upload failed');
                                    }
                                    const result = await response.json();
                                } catch (err) {
                                    uploadStatus.textContent = `Error: ${err.message}`;
                                    progressBar.style.width = '0%';
                                    return;
                                }
                
                                // Update progress
                                const percent = ((i + 1) / files.length) * 100;
                                progressBar.style.width = `${percent}%`;
                            }
                
                            uploadStatus.textContent = 'Upload complete!';
                            setTimeout(() => {
                                uploadProgress.classList.add('hidden');
                                progressBar.style.width = '0%';
                                loadFiles();  // Refresh table
                            }, 1500);
                        }
                
                        // Load files table
                        async function loadFiles() {
                            try {
                                const response = await fetch('/insight');
                                const data = await response.json();
                                const tbody = document.querySelector('#filesTable tbody');
                                const noFiles = document.getElementById('noFiles');
                
                                if (data.files && data.files.length > 0) {
                                    tbody.innerHTML = data.files.map(file => `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800">
                                            <td class="whitespace-nowrap py-4 pl-6 pr-3 text-sm font-medium text-slate-900 dark:text-white flex items-center">
                                                <span class="material-symbols-outlined mr-2 text-slate-400">description</span>
                                                ${file.name}
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-500 dark:text-slate-400">${file.type}</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-500 dark:text-slate-400">${file.size}</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm">
                                                <span class="inline-flex items-center rounded-full bg-slate-100 dark:bg-slate-800 px-2.5 py-0.5 text-xs font-medium text-slate-600 dark:text-slate-300">Indexed</span>
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm font-medium space-x-2">
                                                <a href="/files/${file.name}" class="rounded-full px-3 py-1 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 text-sm hover:bg-slate-200 dark:hover:bg-slate-700 inline-block">View</a>
                                                <button onclick="deleteFile('${file.name}')" class="rounded-full px-3 py-1 text-red-500 dark:text-red-400 text-sm hover:bg-red-50 dark:hover:bg-red-900/20">Remove</button>
                                            </td>
                                        </tr>
                                    `).join('');
                                    noFiles.classList.add('hidden');
                                    tbody.classList.remove('hidden');
                                } else {
                                    tbody.innerHTML = '';
                                    tbody.classList.add('hidden');
                                    noFiles.classList.remove('hidden');
                                }
                            } catch (err) {
                                console.error('Failed to load files:', err);
                            }
                        }
                
                        async function deleteFile(filename) {
                            if (!confirm(`Delete ${filename}?`)) return;
                
                            try {
                                const response = await fetch(`/files/${filename}`, { method: 'DELETE' });
                                if (!response.ok) throw new Error('Delete failed');
                                loadFiles();  // Refresh
                            } catch (err) {
                                alert(`Error: ${err.message}`);
                            }
                        }
                
                        // Initial load
                        document.addEventListener('DOMContentLoaded', loadFiles);
                    </script>
                </div>


            <!-- Alignments Tab -->
            <div id="alignments" class="tab-content hidden">
                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Alignments</h2>
                    <p class="text-gray-500 dark:text-gray-400 mb-8">Configure main categories, sub-services, and options for timelines and budgets to align AI responses effectively.</p>
                    <div class="space-y-10">
                        <!-- Main Categories -->
                        <div>
                            <div class="flex items-center gap-3 mb-3">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" stroke="currentColor"/>
                                </svg>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="main-categories">Main Categories</label>
                            </div>
                            <textarea id="main-categories" class="p-3 focus:outline-none border border-gray-300 block w-full rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-300 transition duration-200 " placeholder='Enter JSON array, e.g., option["Support", "Billing", "Products"]' rows="5"></textarea>
                            
                        </div>
                        <!-- Sub Services -->
                        <div>
                            <div class="flex items-center gap-3 mb-3">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke="currentColor"/>
                                </svg>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="sub-services">Sub Services</label>
                            </div>
                            <textarea id="sub-services" class="p-3 focus:outline-none border border-gray-300 block w-full rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-300 transition duration-200 " placeholder='Enter JSON object, e.g., {"Support": option["Chat", "Email"], "Billing": ["Invoices", "Payments"]}' rows="5"></textarea>
                            
                        </div>
                        <!-- Timeline Options -->
                        <div>
                            <div class="flex items-center gap-3 mb-3">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor"/>
                                </svg>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="timeline-options">Timeline Options</label>
                            </div>
                            <textarea id="timeline-options" class="p-3 focus:outline-none border border-gray-300 block w-full rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-300 transition duration-200 " placeholder='Enter JSON array, e.g., option["1-2 days", "1 week", "1 month"]' rows="3"></textarea>
                            
                        </div>
                        <!-- Budget Options -->
                        <div>
                            <div class="flex items-center gap-3 mb-3">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor"/>
                                </svg>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="budget-options">Budget Options</label>
                            </div>
                            <textarea id="budget-options" class="p-3 focus:outline-none border border-gray-300 block w-full rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 text-gray-900 dark:text-gray-300 transition duration-200 " placeholder='Enter JSON array, e.g., option["Under $500", "$500-$2000", "Over $2000"]' rows="3"></textarea>
                            
                        </div>
                    </div>
                </div>
            </div>
            
            
            <script>
                let originalData = {};
                let hasUnsavedChanges = false;
            
                // Fetch and populate initial data
                async function loadInsight() {
                    try {
                        const response = await fetch('/insight');
                        if (!response.ok) throw new Error('Failed to fetch');
                        const data = await response.json();
                        originalData = { ...data };
                        
                        // Update overview stats
                        document.querySelector('.sources-count').textContent = data.num_sources;
                        document.querySelector('.storage-used').textContent = data.storage_used;
                        document.querySelector('.last-sync').textContent = data.last_sync_display;
                        
                        // Populate tab contents with original values
                        document.getElementById('rules-text').value = data.guidelines;
                        document.getElementById('profile-text').value = data.tones;
                        document.getElementById('name-text').value = data.name;
                        document.getElementById('company-text').value = data.company_profile;
                        document.getElementById('banned-text').value = data.banned;
                        document.getElementById('main-categories').value = data.main_categories;
                        document.getElementById('sub-services').value = data.sub_services;
                        document.getElementById('timeline-options').value = data.timeline_options;
                        document.getElementById('budget-options').value = data.budget_options;
                        
                        updateUnsavedIndicator();
                    } catch (error) {
                        console.error('Failed to load insight:', error);
                        // Fallback to defaults if needed
                    }
                }
            
                // Track changes
                function addChangeListeners() {
                    const inputs = ['rules-text','banned-text','company-text','name-text', 'profile-text', 'main-categories', 'sub-services', 'timeline-options', 'budget-options'];
                    inputs.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.addEventListener('input', () => {
                                checkForChanges();
                            });
                        }
                    });
                }
            
                function checkForChanges() {
                    const current = {
                        guidelines: document.getElementById('rules-text').value,
                        tones: document.getElementById('profile-text').value,
                        name:document.getElementById('name-text').value,
                        company_profile:document.getElementById('company-text').value,
                        banned:document.getElementById('banned-text').value,
                        main_categories: document.getElementById('main-categories').value,
                        sub_services: document.getElementById('sub-services').value,
                        timeline_options: document.getElementById('timeline-options').value,
                        budget_options: document.getElementById('budget-options').value
                    };
                    // Compare to originals (which are now raw strings, possibly "")
                    hasUnsavedChanges = JSON.stringify(current) !== JSON.stringify({
                        guidelines: originalData.guidelines || "",
                        tones: originalData.tones || "",
                        name: originalData.name || "",
                        company_profile: originalData.company_profile || "",
                        banned: originalData.banned || "",
                        main_categories: originalData.main_categories || "",
                        sub_services: originalData.sub_services || "",
                        timeline_options: originalData.timeline_options || "",
                        budget_options: originalData.budget_options || ""
                    });
                    updateUnsavedIndicator();
                }
            
                function updateUnsavedIndicator() {
                    const indicator = document.getElementById('unsaved-dot');
                    if (hasUnsavedChanges) {
                        indicator.classList.remove('hidden');
                    } else {
                        indicator.classList.add('hidden');
                    }
                }
            
                // Tab switching with smooth transitions
                document.querySelectorAll('.inner-tab-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tab = link.dataset.tab;
                        
                        // Update active tab
                        document.querySelectorAll('.inner-tab-link').forEach(l => {
                            l.classList.remove('active-tab', 'text-gray-900', 'border-gray-800');
                            l.classList.add('text-gray-500', 'border-transparent');
                        });
                        document.querySelectorAll('.tab-content').forEach(c => {
                            c.classList.remove('active');
                            c.classList.add('hidden');
                        });
                        link.classList.add('active-tab', 'text-gray-900', 'border-gray-800');
                        link.classList.remove('text-gray-500', 'border-transparent');
                        const targetTab = document.getElementById(tab);
                        targetTab.classList.remove('hidden');
                        targetTab.classList.add('active');
                    });
                });
            
                // Single save function
                async function saveData(updateData) {
                    const btn = document.getElementById('sync-btn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<span class="material-symbols-outlined text-base animate-spin">sync</span> Saving...';
                    btn.disabled = true;
                    
                    try {
                        const response = await fetch('/insight', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updateData)
                        });
                        if (response.ok) {
                            originalData = { ...updateData };  // Update originals
                            hasUnsavedChanges = false;
                            updateUnsavedIndicator();
                            loadInsight();  // Reload to update last_synced and stats
                            // Placeholder for actual sync logic
                            setTimeout(() => alert('Saved and synced successfully!'), 500);
                        } else {
                            throw new Error('Save failed');
                        }
                    } catch (error) {
                        console.error('Save error:', error);
                        alert('Save failed. Please try again.');
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }
            
                // Sync button as single save
                document.getElementById('sync-btn').addEventListener('click', () => {
                    if (!hasUnsavedChanges) {
                        alert('No changes to save.');
                        return;
                    }
                    const updateData = {
                        guidelines: document.getElementById('rules-text').value,
                        tones: document.getElementById('profile-text').value,
                        name: document.getElementById('name-text').value,
                        company_profile: document.getElementById('company-text').value,
                        banned: document.getElementById('banned-text').value,
                        main_categories: document.getElementById('main-categories').value,
                        sub_services: document.getElementById('sub-services').value,
                        timeline_options: document.getElementById('timeline-options').value,
                        budget_options: document.getElementById('budget-options').value
                    };
                    saveData(updateData);
                });
            
                // Initialize
                loadInsight().then(addChangeListeners);
            </script>
    

                    <div id="templates" class="tab-content hidden">
                        <div id="template-manager-container" class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                                Template Management
                            </h2>
                            <p class="text-gray-500 dark:text-gray-400 mb-8">Create, modify, and organize standardized templates</p>

                            <div id="alert-container">
                            </div>
                    
                            <div id="add-template-section" class="mb-12 border border-gray-200 rounded-lg bg-white shadow-sm overflow-hidden">
                                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    <h2 class="text-lg font-semibold text-gray-800">Create New Definition</h2>
                                </div>
                                
                                <div class="p-6">
                                    <form id="template-creation-form" onsubmit="handleJsonSubmit(event)">
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                            <div class="col-span-1">
                                                <label for="template-name-input" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Template Name</label>
                                                <input type="text" id="template-name-input" name="name" required
                                                    class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-800 focus:border-gray-800 sm:text-sm py-2 px-3"
                                                    placeholder="e.g. Onboarding Workflow">
                                            </div>
                                            <div class="col-span-2">
                                                <label for="template-description-input" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Description</label>
                                                <input type="text" id="template-description-input" name="description"
                                                    class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-800 focus:border-gray-800 sm:text-sm py-2 px-3"
                                                    placeholder="Brief description of this service template">
                                            </div>
                                        </div>
                                        
                                        <div id="task-list-area">
                                            <div class="flex justify-between items-end mb-4">
                                                <h3 class="text-sm font-semibold text-gray-700">Default Task Sequence</h3>
                                                <button type="button" onclick="addTaskField()" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                                    <svg class="-ml-0.5 mr-2 h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                                    Add Task
                                                </button>
                                            </div>
                                            
                                            <div class="grid grid-cols-12 gap-4 px-3 mb-2 text-xs font-medium text-gray-400 uppercase">
                                                <div class="col-span-4">Title</div>
                                                <div class="col-span-5">Description</div>
                                                <div class="col-span-1 text-center">Seq</div>
                                                <div class="col-span-1 text-center">Milestone</div>
                                                <div class="col-span-1"></div>
                                            </div>
                    
                                            <div id="template-tasks-container" class="space-y-2">
                                                </div>
                                        </div>
                                        
                                        <div class="mt-8 pt-6 border-t border-gray-100 flex justify-end">
                                            <button type="submit" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 transition-colors">
                                                Save Template
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                    
                            <div id="existing-templates-section">
                                <div class="flex items-center gap-3 mb-6">
                                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>
                                    <h2 class="text-2xl font-bold text-gray-900">Existing Templates <span id="template-count" class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">0</span></h2>
                                </div>
                                
                                <div id="templates-list-ul" class="grid grid-cols-1 gap-6">
                                    <div class="text-center py-12 bg-gray-50 border border-dashed border-gray-300 rounded-lg hidden" id="loading-spinner">
                                        <svg class="animate-spin h-6 w-6 mx-auto text-gray-500 mb-2" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span class="text-sm text-gray-500">Syncing data...</span>
                                    </div>
                                    <div class="text-center py-12 bg-gray-50 border border-dashed border-gray-300 rounded-lg hidden" id="empty-message">
                                        <p class="text-sm text-gray-500">No templates found. Create your first service definition above.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                        const taskContainer = document.getElementById('template-tasks-container');
                        const alertContainer = document.getElementById('alert-container');
                        const templatesListUl = document.getElementById('templates-list-ul');
                        const loadingSpinner = document.getElementById('loading-spinner');
                        const emptyMessage = document.getElementById('empty-message');
                        const templateCountSpan = document.getElementById('template-count');
                    
                        let globalTaskSequence = 1;
                    
                        // --- Utility Functions ---
                    
                        function showAlert(message, type = 'success') {
                            const isSuccess = type === 'success';
                            const bgColor = isSuccess ? 'bg-gray-800' : 'bg-red-50';
                            const textColor = isSuccess ? 'text-white' : 'text-red-800';
                            const borderColor = isSuccess ? 'border-gray-900' : 'border-red-200';
                            
                            // Simple Toast Style
                            const html = `
                                <div class="${bgColor} ${borderColor} border ${textColor} px-4 py-3 rounded shadow-md mb-6 flex items-center justify-between transition-all duration-500" role="alert">
                                    <div class="flex items-center">
                                        ${isSuccess ? 
                                            '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' : 
                                            '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                                        }
                                        <span class="font-medium text-sm">${message}</span>
                                    </div>
                                </div>
                            `;
                            alertContainer.innerHTML = html;
                            setTimeout(() => {
                                alertContainer.innerHTML = '';
                            }, 4000);
                        }
                    
                        // --- Task Field Management (Add/Remove) ---
                    
                        function addTaskField(isInitial = false) {
                            globalTaskSequence++;
                            
                            const taskRow = document.createElement('div');
                            taskRow.className = 'task-list-item bg-white border border-gray-200 rounded p-3 transition-all duration-200 hover:border-gray-400';
                            taskRow.dataset.sequence = globalTaskSequence;
                    
                            taskRow.innerHTML = `
                                <div class="grid grid-cols-12 gap-4 items-center">
                                    <div class="col-span-4">
                                        <input type="text" name="task_title" required
                                            class="task-title-input block w-full border-gray-300 rounded text-sm focus:ring-gray-500 focus:border-gray-500 py-1.5" 
                                            placeholder="Task Name">
                                    </div>
                                    <div class="col-span-5">
                                        <input type="text" name="task_description"
                                            class="task-description-input block w-full border-gray-300 rounded text-sm focus:ring-gray-500 focus:border-gray-500 py-1.5" 
                                            placeholder="Instructions...">
                                    </div>
                                    <div class="col-span-1">
                                        <input type="number" name="task_sequence" value="${globalTaskSequence}" min="1"
                                            class="task-sequence-input block w-full border-gray-300 rounded text-sm text-center focus:ring-gray-500 focus:border-gray-500 py-1.5">
                                    </div>
                                    <div class="col-span-1 text-center flex justify-center">
                                        <input type="checkbox" name="task_is_milestone"
                                            class="task-milestone-input h-4 w-4 text-gray-900 border-gray-300 rounded focus:ring-gray-500">
                                    </div>
                                    <div class="col-span-1 text-right">
                                        <button type="button" onclick="removeTaskField(this)" class="text-gray-400 hover:text-red-600 transition-colors p-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            `;
                    
                            taskContainer.appendChild(taskRow);
                            
                            if (!isInitial) {
                                taskRow.querySelector('.task-title-input').focus();
                            }
                        }
                    
                        function removeTaskField(button) {
                            const taskField = button.closest('.task-list-item');
                            if (taskField) {
                                taskField.style.opacity = '0';
                                setTimeout(() => {
                                    taskField.remove();
                                }, 200);
                            }
                        }
                    
                        // --- Data Collection for POST ---
                    
                        function collectFormData() {
                            const form = document.getElementById('template-creation-form');
                            const name = form.querySelector('#template-name-input').value.trim();
                            const description = form.querySelector('#template-description-input').value.trim();
                            
                            if (!name) return showAlert("Template Name is required.", 'error') && null;
                    
                            const tasks = [];
                            const taskRows = taskContainer.querySelectorAll('.task-list-item');
                    
                            taskRows.forEach(row => {
                                const titleInput = row.querySelector('.task-title-input');
                                
                                if (titleInput && titleInput.value.trim()) {
                                    const descriptionInput = row.querySelector('.task-description-input');
                                    const sequenceInput = row.querySelector('.task-sequence-input');
                                    const milestoneInput = row.querySelector('.task-milestone-input');
                    
                                    tasks.push({
                                        title: titleInput.value.trim(),
                                        description: descriptionInput ? descriptionInput.value.trim() : null,
                                        sequence_number: sequenceInput ? parseInt(sequenceInput.value) : 1,
                                        is_milestone: milestoneInput ? milestoneInput.checked : false
                                    });
                                }
                            });
                            
                            return {
                                name: name,
                                description: description || null,
                                default_tasks: tasks.sort((a, b) => a.sequence_number - b.sequence_number)
                            };
                        }
                    
                        // --- API & Submission Handlers ---
                    
                        async function handleJsonSubmit(event) {
                            event.preventDefault(); 
                            const templateData = collectFormData();
                            if (!templateData) return; 
                    
                            try {
                                const response = await fetch(`/api/templates/`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(templateData),
                                });
                    
                                const result = await response.json();
                    
                                if (!response.ok) {
                                    throw new Error(result.detail || `HTTP error! Status: ${response.status}`);
                                }
                    
                                showAlert(`Template '${result.name}' created successfully!`);
                                document.getElementById('template-creation-form').reset();
                                taskContainer.innerHTML = ''; 
                                globalTaskSequence = 0;
                                addTaskField(true); 
                                
                                await fetchAndRenderTemplates(); 
                                
                            } catch (error) {
                                showAlert(`Creation failed: ${error.message}`, 'error');
                                console.error('Submission failed:', error);
                            }
                        }
                    
                        async function handleDeleteTemplate(templateId, templateName) {
                            if (!confirm(`Delete template "${templateName}"? This cannot be undone.`)) return;
                            
                            try {
                                const response = await fetch(`/api/templates/${templateId}`, {
                                    method: 'DELETE',
                                });
                                const result = await response.json();
                    
                                if (!response.ok) {
                                    throw new Error(result.detail || `HTTP error! Status: ${response.status}`);
                                }
                    
                                showAlert("Template deleted successfully.");
                                
                                const listItem = document.getElementById(`template-item-${templateId}`);
                                if (listItem) {
                                    listItem.style.opacity = '0';
                                    setTimeout(() => {
                                        listItem.remove();
                                        const count = parseInt(templateCountSpan.textContent) - 1;
                                        templateCountSpan.textContent = count < 0 ? 0 : count;
                                        if (count <= 0) emptyMessage.classList.remove('hidden');
                                    }, 300);
                                }
                            } catch (error) {
                                showAlert(`Deletion failed: ${error.message}`, 'error');
                            }
                        }
                    
                        async function handleDeleteTask(taskId, taskTitle) {
                            if (!confirm(`Remove step "${taskTitle}" from this template?`)) return;
                            
                            try {
                                const response = await fetch(`/api/tasks/${taskId}`, {
                                    method: 'DELETE',
                                });
                                const result = await response.json();
                    
                                if (!response.ok) {
                                    throw new Error(result.detail || `HTTP error! Status: ${response.status}`);
                                }
                    
                                showAlert("Task removed.");
                    
                                const taskRow = document.getElementById(`task-row-existing-${taskId}`);
                                if (taskRow) {
                                    taskRow.style.opacity = '0';
                                    setTimeout(() => taskRow.remove(), 300);
                                }
                            } catch (error) {
                                showAlert(`Task deletion failed: ${error.message}`, 'error');
                            }
                        }
                    
                    
                        // --- Rendering Logic (GET) ---
                    
                        function renderTemplate(template) {
                            const taskHtml = template.default_tasks.map(task => `
                                <div id="task-row-existing-${task.id}" class="group flex items-start py-2 border-b border-gray-100 last:border-0 hover:bg-gray-50 px-3 -mx-3 rounded">
                                    <div class="flex-shrink-0 pt-1">
                                        <span class="flex items-center justify-center h-5 w-5 rounded bg-gray-100 text-xs font-medium text-gray-500">
                                            ${task.sequence_number}
                                        </span>
                                    </div>
                                    <div class="ml-3 flex-1 min-w-0">
                                        <div class="flex items-center justify-between">
                                            <p class="text-sm font-medium text-gray-900 truncate">${task.title}</p>
                                            ${task.is_milestone ? 
                                                '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">Milestone</span>' : ''}
                                        </div>
                                        ${task.description ? `<p class="text-xs text-gray-500 truncate">${task.description}</p>` : ''}
                                    </div>
                                    <div class="ml-4 flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="handleDeleteTask(${task.id}, '${task.title.replace(/'/g, "\\'")}')" 
                                                class="text-gray-400 hover:text-red-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                    
                            return `
                                <div id="template-item-${template.id}" class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200">
                                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-start bg-gray-50 rounded-t-lg">
                                        <div>
                                            <h3 class="text-lg font-bold text-gray-900 leading-6">${template.name}</h3>
                                            <p class="mt-1 text-sm text-gray-500">${template.description || 'No description provided.'}</p>
                                        </div>
                                        <button onclick="handleDeleteTemplate(${template.id}, '${template.name.replace(/'/g, "\\'")}')" 
                                                class="text-xs font-medium text-gray-400 hover:text-red-600 transition-colors">
                                            Delete
                                        </button>
                                    </div>
                                    <div class="px-6 py-4">
                                        <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Workflow Steps</h4>
                                        <div class="space-y-1">
                                            ${taskHtml.length > 0 ? taskHtml : '<p class="text-sm text-gray-400 italic">No tasks defined.</p>'}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    
                        async function fetchAndRenderTemplates() {
                            templatesListUl.innerHTML = '';
                            loadingSpinner.classList.remove('hidden');
                            emptyMessage.classList.add('hidden');
                            templateCountSpan.textContent = 0;
                    
                            try {
                                const response = await fetch(`/api/templates/`);
                                const templates = await response.json();
                    
                                if (!response.ok) throw new Error(templates.detail || 'Failed to fetch templates.');
                    
                                loadingSpinner.classList.add('hidden');
                    
                                if (templates.length === 0) {
                                    emptyMessage.classList.remove('hidden');
                                } else {
                                    const htmlContent = templates.map(renderTemplate).join('');
                                    templatesListUl.innerHTML = htmlContent;
                                    templateCountSpan.textContent = templates.length;
                                }
                    
                            } catch (error) {
                                loadingSpinner.classList.add('hidden');
                                templatesListUl.innerHTML = `<div class="text-red-600 text-sm p-4 bg-red-50 rounded-md border border-red-100">Unable to load templates: ${error.message}</div>`;
                                console.error("Fetch Error:", error);
                            }
                        }
                    
                        // --- Initialization ---
                        document.addEventListener('DOMContentLoaded', () => {
                            addTaskField(true); 
                            fetchAndRenderTemplates();
                        });
                                    
                    </script>

                    <div id="consultants" class="tab-content hidden">
                            <div id="consultant-manager-fetch-container" class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                                    Consultant Management
                                </h2>
                                <p class="text-gray-500 dark:text-gray-400 mb-8">Manage and assign consultants, track performance, and define roles to optimize project delivery and expertise utilization</p>
                    
                            <div id="add-consultant-section-fetch" class="mb-12 border border-gray-200 rounded-lg bg-white shadow-sm overflow-hidden">
                                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                                    <h2 class="text-lg font-semibold text-gray-800">Register New Consultant</h2>
                                </div>
                    
                                <div class="p-6">
                                    <form id="add-consultant-form-fetch">
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                            <div>
                                                <label for="consultant_name_input_fetch" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Full Name</label>
                                                <input type="text" id="consultant_name_input_fetch" name="name" required 
                                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-800 focus:border-gray-800 sm:text-sm py-2 px-3"
                                                       placeholder="e.g. Jane Doe">
                                            </div>
                                            <div>
                                                <label for="consultant_phone_input_fetch" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Phone (Optional)</label>
                                                <input type="text" id="consultant_phone_input_fetch" name="phone" 
                                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-800 focus:border-gray-800 sm:text-sm py-2 px-3"
                                                       placeholder="+1 (555) 000-0000">
                                            </div>
                                            <div>
                                                <label for="consultant_tier_select_fetch" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Tier Level</label>
                                                <input type="text" id="consultant_tier_select_fetch" name="tier" 
                                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-gray-800 focus:border-gray-800 sm:text-sm py-2 px-3"
                                                       placeholder="e.g. Senior">
                                            </div>
                                        </div>
                                        <div class="pt-4 border-t border-gray-100 flex justify-end">
                                            <button type="submit" id="consultantFormBtn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 transition-colors">
                                                Add Consultant
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                    
                            <div id="consultant-list-section-fetch">
                                <div class="flex items-center justify-between mb-6">
                                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Existing Consultants</h2>
                                    <button onclick="fetchConsultants()" class="group inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
                                        <svg class="w-4 h-4 mr-2 text-text-secondary-light dark:text-text-secondary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg> Refresh
                                    </button>
                                </div>
                    
                                <div class="overflow-hidden border border-gray-200 rounded-lg shadow-sm">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Name</th>
                                                <th scope="col" class="px-3 py-3.5 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Phone</th>
                                                <th scope="col" class="px-3 py-3.5 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tier</th>
                                                <th scope="col" class="px-3 py-3.5 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Joined</th>
                                                <th scope="col" class="relative py-3.5 pl-3 pr-4">
                                                    <span class="sr-only">Actions</span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="consultant-table-body-fetch" class="divide-y divide-gray-200 bg-white">
                                            <tr><td colspan="5" class="p-8 text-center text-sm text-gray-500">Loading data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                        const tableBody = document.getElementById("consultant-table-body-fetch");
                        const statusMessage = document.getElementById("status-message");
                    
                    
                        function formatTier(tier) {
                            if (!tier) return '<span class="text-gray-400"></span>';
                            
                            // Mapping specific keywords to subtle badges, otherwise generic gray
                            const lowerTier = tier.toLowerCase();
                            let classes = 'bg-gray-100 text-gray-800'; // Default
                            
                            if (lowerTier.includes('senior') || lowerTier.includes('lead')) {
                                classes = 'bg-gray-800 text-white'; // High contrast for high tiers
                            } else if (lowerTier.includes('junior') || lowerTier.includes('associate')) {
                                classes = 'bg-white border border-gray-200 text-gray-600'; // Subtle for lower
                            }
                    
                            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${classes}">${tier.charAt(0).toUpperCase() + tier.slice(1)}</span>`;
                        }
                    
                        function formatDate(isoDate) {
                            if (!isoDate) return '<span class="text-gray-400">N/A</span>';
                            try {
                                return new Date(isoDate).toLocaleDateString('en-US', {
                                    year: 'numeric', month: 'short', day: 'numeric'
                                });
                            } catch (e) {
                                return 'Invalid Date';
                            }
                        }
                    
                        // --- Core Fetch Functions ---
                    
                        async function fetchConsultants() {
                            tableBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400 italic">Updating roster...</td></tr>';
                    
                            try {
                                const response = await fetch('/api/consultants');
                                if (!response.ok) throw new Error('Failed to fetch consultants.');
                                
                                const consultants = await response.json();
                                
                                tableBody.innerHTML = ''; 
                    
                                if (consultants.length === 0) {
                                    tableBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">No consultants found. Register a new consultant above.</td></tr>';
                                    return;
                                }
                    
                                consultants.forEach(c => {
                                    const row = `
                                        <tr id="consultant-list-row-fetch-${c.id}" class="hover:bg-gray-50 transition-colors">
                                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900">${c.name}</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 font-mono">${c.phone || ''}</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${formatTier(c.tier)}</td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${formatDate(c.created_at)}</td>
                                            <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium">
                                                <button onclick="deleteConsultant('${c.id}')" class="text-gray-400 hover:text-red-600 transition-colors p-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                    tableBody.innerHTML += row;
                                });
                    
                            } catch (error) {
                                console.error('Error fetching consultants:', error);
                                tableBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-red-600 bg-red-50">Error loading data. Please check the backend connection.</td></tr>';
                            }
                        }
                    
                        document.getElementById('add-consultant-form-fetch').addEventListener('submit', async function(event) {
                            event.preventDefault();
                            
                            const formData = new FormData(event.target);
                            const consultantData = Object.fromEntries(formData.entries());
                            const consultantFormBtn = document.getElementById('consultantFormBtn');

                            const originalButtonText = consultantFormBtn.innerHTML;
                            consultantFormBtn.innerHTML = "Submitting...";
                            consultantFormBtn.disabled = true; 
                            
                            try {
                                const response = await fetch('/api/consultant', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(consultantData)
                                });
                                if (response.ok) {
                                    const newConsultant = await response.json();
                                    showPopup("Consultant Added");
                                    await fetchConsultants();
                                    event.target.reset(); 
                                    
                                } else {
                                    const error = await response.json();
                                    throw new Error(error.detail || `Failed to add consultant. Status: ${response.statusText}`);
                                }
                            
                            } catch (error) {
                                console.log("");
                            } finally {
                                consultantFormBtn.innerHTML = originalButtonText; 
                                consultantFormBtn.disabled = false; 
                            }
                        });
                    
                        async function deleteConsultant(consultantId) {
                            if (!confirm('Are you sure you want to remove this consultant from the roster?')) return;
                            
                            try {
                                // FIX: The URL was incorrectly constructed. It should be '/api/consultant/' + consultantId
                                const response = await fetch('/api/consultant/' + consultantId, {
                                    method: 'DELETE',
                                });
                                
                                if (response.ok) {
                                    const message = await response.json();
                                    
                                    // Visual removal transition
                                    const row = document.getElementById(`consultant-list-row-fetch-${consultantId}`);
                                    if(row) {
                                        row.style.opacity = '0';
                                        setTimeout(() => row.remove(), 300);
                                    }
                                    
                                    showPopup("Consultant removed successfully.");
                                } else {
                                    const error = await response.json();
                                    throw new Error(error.detail || 'Failed to delete consultant.');
                                }
                            } catch (error) {
                                console.error('Delete consultant error:', error);
                                showPopup('Deletion failed');
                            }
                        }
                    
                        // Initial load
                        document.addEventListener('DOMContentLoaded', fetchConsultants);
                    </script>

                </div>

                <div id="sessions-tab" class="tab-panel hidden">
                    
                    <div class="flex items-start justify-between mb-6">
                      <header class="mb-8">
                        <h1 class="text-4xl font-bold text-gray-800 dark:text-white">Chat Sessions</h1>
                      <p class="text-gray-500 dark:text-gray-400">Monitor all chatbot conversations</p>
                      </header>
                      <div class="flex items-center gap-2">
                        <div class="toggle-container">
                          <button id="allSessionsBtn" class="toggle-btn active" data-mode="all">All Sessions</button>
                          <button id="activeOnlyBtn" class="toggle-btn inactive" data-mode="active">Active Only</button>
                        </div>
                      </div>
                    </div>

                        <div id="content-dashboard" class="flex-1 p-6 overflow-y-auto">
                            
                            <div id="sessionsList" class="bg-surface-light dark:bg-surface-dark rounded-lg shadow-sm">
                            </div>
                            <div id="paginationControls" class="flex items-center justify-between px-4 py-3 bg-gray-50 border-t border-gray-200 mt-4">
                              <div class="text-xs text-gray-600">
                                <span id="paginationInfo">Page 1 of 1</span>
                              </div>
                              <div class="flex items-center gap-2">
                                <button id="prevPageBtn" onclick="changePage(-1)" class="inline-flex items-center gap-1 px-3 py-1.5 bg-white border border-gray-200 rounded text-xs hover:shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                                  Prev
                                </button>
                                <button id="nextPageBtn" onclick="changePage(1)" class="inline-flex items-center gap-1 px-3 py-1.5 bg-white border border-gray-200 rounded text-xs hover:shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                  Next
                                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                </button>
                              </div>
                            </div>
                        </div>


                </div>

                <div id="leads-tab" class="tab-panel hidden">
                        <div class="flex justify-between items-start mb-8">
                            <header class="mb-8">
                                <h1 class="text-4xl font-bold text-gray-800 dark:text-white">Leads</h1>
                                <p class="text-gray-500 dark:text-gray-400">Manage and export captured leads</p>
                            </header>
                            <button id="exportBtn" class="bg-gray-900 dark:bg-gray-200 text-white dark:text-gray-900 font-semibold py-2.5 px-4 rounded-full flex items-center gap-2 hover:bg-gray-800 dark:hover:bg-white transition-colors">
                                <svg width="15" height="15" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12.5535 16.5061C12.4114 16.6615 12.2106 16.75 12 16.75C11.7894 16.75 11.5886 16.6615 11.4465 16.5061L7.44648 12.1311C7.16698 11.8254 7.18822 11.351 7.49392 11.0715C7.79963 10.792 8.27402 10.8132 8.55352 11.1189L11.25 14.0682V3C11.25 2.58579 11.5858 2.25 12 2.25C12.4142 2.25 12.75 2.58579 12.75 3V14.0682L15.4465 11.1189C15.726 10.8132 16.2004 10.792 16.5061 11.0715C16.8118 11.351 16.833 11.8254 16.5535 12.1311L12.5535 16.5061Z" fill="currentColor"/>
                                    <path d="M3.75 15C3.75 14.5858 3.41422 14.25 3 14.25C2.58579 14.25 2.25 14.5858 2.25 15V15.0549C2.24998 16.4225 2.24996 17.5248 2.36652 18.3918C2.48754 19.2919 2.74643 20.0497 3.34835 20.6516C3.95027 21.2536 4.70814 21.5125 5.60825 21.6335C6.47522 21.75 7.57754 21.75 8.94513 21.75H15.0549C16.4225 21.75 17.5248 21.75 18.3918 21.6335C19.2919 21.5125 20.0497 21.2536 20.6517 20.6516C21.2536 20.0497 21.5125 19.2919 21.6335 18.3918C21.75 17.5248 21.75 16.4225 21.75 15.0549V15C21.75 14.5858 21.4142 14.25 21 14.25C20.5858 14.25 20.25 14.5858 20.25 15C20.25 16.4354 20.2484 17.4365 20.1469 18.1919C20.0482 18.9257 19.8678 19.3142 19.591 19.591C19.3142 19.8678 18.9257 20.0482 18.1919 20.1469C17.4365 20.2484 16.4354 20.25 15 20.25H9C7.56459 20.25 6.56347 20.2484 5.80812 20.1469C5.07435 20.0482 4.68577 19.8678 4.40901 19.591C4.13225 19.3142 3.9518 18.9257 3.85315 18.1919C3.75159 17.4365 3.75 16.4354 3.75 15Z" fill="currentColor"/>
                                    </svg>
                                Export CSV
                            </button>
                        </div>
                        <div class="flex items-center gap-4 mb-6">
                            <div class="relative flex-grow">
                                <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xl" width="15" height="15" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11 6C13.7614 6 16 8.23858 16 11M16.6588 16.6549L21 21M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                <input id="searchInput" class="w-full pl-10 pr-4 py-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 focus:ring-primary focus:border-primary" placeholder="Search leads by name, email, or company..." type="text"/>
                            </div>
                            <button id="refreshBtn" class="border px-2 border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 py-2.5 focus:ring-primary focus:border-primary" >Refresh Cache</button>
                            <select id="scoreSelect" class="border px-2 border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 py-2.5 focus:ring-primary focus:border-primary">
                                <option value="">All Scores</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" scope="col">Name</th>
                                        <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" scope="col">Email</th>
                                        <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" scope="col">Company</th>
                                        <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" scope="col">Service</th>
                                        <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" scope="col">Score</th>
                                        <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" scope="col">Date</th>
                                        <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="leadsTbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                                   
                                </tbody>
                            </table>
                        </div>
                        <div id="pagination" class="flex justify-center items-center mt-6 space-x-2">
                            <button id="LeadprevBtn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded disabled:opacity-50 disabled:cursor-not-allowed" disabled>Previous</button>
                            <span id="pageInfo" class="text-sm text-gray-500 dark:text-gray-400">Page 1 of 1</span>
                            <button id="LeadnextBtn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                        </div>
                </div>

                <div id="projects-tab" class="tab-panel hidden">
                    <div class="flex justify-between items-start mb-8">
                        <header class="mb-8">
                            <h1 class="text-4xl font-bold text-gray-800 dark:text-white">Projects</h1>
                            <p class="text-gray-500 dark:text-gray-400">Manage Projects</p>
                        </header>
                        
                    </div>
                    
                    <div class=" rounded-2xl p-0  overflow-hidden">
                        <div id="project-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="col-span-full text-center py-20 text-gray-400">Loading projects...</div>
                        </div>
                    </div>
                 
                    
                </div>

            </div>
        </main>
    </div>

    <!-- CHAT - WARNING -->

    <div id="chatModal" class="fixed inset-0 hidden z-50 overflow-hidden">
        <div class="absolute inset-0 bg-black/50" onclick="closeChat()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
          <div class="w-full max-w-[90rem] h-[90vh] bg-white rounded-[.9rem] shadow-xl flex overflow-hidden">
            <!-- Left Panel: User & Company Details -->
            <div id="userDetailsSection" class="w-1/3 bg-gray-50 border-r border-gray-200 p-0 overflow-y-auto">
              <!-- User details tabs will be rendered here -->
            </div>
            <!-- Right Panel: Chat -->
            <div class="flex-1 flex flex-col">
              <!-- Chat Header -->
              <div class="flex flex-row-reverse items-center justify-between px-6 py-4 border-b border-gray-200 bg-white">
                <div class="flex items-center gap-3">
                  <div>
                    <h2 id="chatTitle" class="flex text-sm font-semibold">Session Chat</h2>
                  </div>
                  <button id="closeModalBtn" class="p-2 rounded-lg hover:bg-gray-100 transition" onclick="closeChat()" aria-label="Close">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                </div>
                
              </div>
              <!-- Messages -->
              <div id="messagesContainer" class="flex-1 px-6 py-4 overflow-auto space-y-4 bg-gradient-to-b from-gray-50/30 to-white">
                <!-- messages will be appended here -->
              </div>
              <!-- Input Area -->
              <div id="inputArea" class="px-6 py-4 border-t border-gray-100 bg-white hidden">
                <div class="relative flex items-center">
                  <textarea
                    id="messageInput"
                    type="text"
                    placeholder="Type message as admin..."
                    class="flex-1 px-4 py-3 pr-12 border border-gray-200 rounded-full focus:outline-none   focus:ring-primary/30 focus:border-transparent transition resize-none h-12"
                    rows="1"
                  ></textarea>
                  <button
                    id="sendBtn"
                    class="absolute right-[3.6rem] top-1/2 transform -translate-y-1/2 inline-flex items-center justify-center w-9 h-9 bg-gray-800 text-white rounded-full hover:bg-gray-800/90 transition shadow-sm hover:shadow focus:outline-none focus:ring-1 "
                    title="Send"
                  >
                  <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M8.99992 16V6.41407L5.70696 9.70704C5.31643 10.0976 4.68342 10.0976 4.29289 9.70704C3.90237 9.31652 3.90237 8.6835 4.29289 8.29298L9.29289 3.29298L9.36907 3.22462C9.76184 2.90427 10.3408 2.92686 10.707 3.29298L15.707 8.29298L15.7753 8.36915C16.0957 8.76192 16.0731 9.34092 15.707 9.70704C15.3408 10.0732 14.7618 10.0958 14.3691 9.7754L14.2929 9.70704L10.9999 6.41407V16C10.9999 16.5523 10.5522 17 9.99992 17C9.44764 17 8.99992 16.5523 8.99992 16Z"></path></svg>
                  </button>
                  <button id="handoverBtn" class="ml-3 inline-flex items-center justify-center w-10 h-10 border border-gray-200 rounded-full hover:bg-gray-50 transition shadow-sm focus:outline-none   focus:ring-gray-300" title="Handover to bot" style="display: none;">
                    <svg class="w-5 h-5 text-gray-500" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg">
                      <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <g fill="currentColor" fill-rule="nonzero">
                          <path d="M17.7530511,13.999921 C18.9956918,13.999921 20.0030511,15.0072804 20.0030511,16.249921 L20.0030511,17.1550008 C20.0030511,18.2486786 19.5255957,19.2878579 18.6957793,20.0002733 C17.1303315,21.344244 14.8899962,22.0010712 12,22.0010712 C9.11050247,22.0010712 6.87168436,21.3444691 5.30881727,20.0007885 C4.48019625,19.2883988 4.00354153,18.2500002 4.00354153,17.1572408 L4.00354153,16.249921 C4.00354153,15.0072804 5.01090084,13.999921 6.25354153,13.999921 L17.7530511,13.999921 Z M17.7530511,15.499921 L6.25354153,15.499921 C5.83932796,15.499921 5.50354153,15.8357075 5.50354153,16.249921 L5.50354153,17.1572408 C5.50354153,17.8128951 5.78953221,18.4359296 6.28670709,18.8633654 C7.5447918,19.9450082 9.44080155,20.5010712 12,20.5010712 C14.5599799,20.5010712 16.4578003,19.9446634 17.7186879,18.8621641 C18.2165778,18.4347149 18.5030511,17.8112072 18.5030511,17.1550005 L18.5030511,16.249921 C18.5030511,15.8357075 18.1672647,15.499921 17.7530511,15.499921 Z M11.8985607,2.00734093 L12.0003312,2.00049432 C12.380027,2.00049432 12.6938222,2.2826482 12.7434846,2.64872376 L12.7503312,2.75049432 L12.7495415,3.49949432 L16.25,3.5 C17.4926407,3.5 18.5,4.50735931 18.5,5.75 L18.5,10.254591 C18.5,11.4972317 17.4926407,12.504591 16.25,12.504591 L7.75,12.504591 C6.50735931,12.504591 5.5,11.4972317 5.5,10.254591 L5.5,5.75 C5.5,4.50735931 6.50735931,3.5 7.75,3.5 L11.2495415,3.49949432 L11.2503312,2.75049432 C11.2503312,2.37079855 11.5324851,2.05700336 11.8985607,2.00734093 L12.0003312,2.00049432 L11.8985607,2.00734093 Z M16.25,5 L7.75,5 C7.33578644,5 7,5.33578644 7,5.75 L7,10.254591 C7,10.6688046 7.33578644,11.004591 7.75,11.004591 L16.25,11.004591 C16.6642136,11.004591 17,10.6688046 17,10.254591 L17,5.75 C17,5.33578644 16.6642136,5 16.25,5 Z M9.74928905,6.5 C10.4392523,6.5 10.9985781,7.05932576 10.9985781,7.74928905 C10.9985781,8.43925235 10.4392523,8.99857811 9.74928905,8.99857811 C9.05932576,8.99857811 8.5,8.43925235 8.5,7.74928905 C8.5,7.05932576 9.05932576,6.5 9.74928905,6.5 Z M14.2420255,6.5 C14.9319888,6.5 15.4913145,7.05932576 15.4913145,7.74928905 C15.4913145,8.43925235 14.9319888,8.99857811 14.2420255,8.99857811 C13.5520622,8.99857811 12.9927364,8.43925235 12.9927364,7.74928905 C12.9927364,7.05932576 13.5520622,6.5 14.2420255,6.5 Z"/>
                        </g>
                      </g>
                    </svg>
                  </button>
                </div>
                
              </div>
            </div>
          </div>
        </div>
    </div>
      <!-- Warning Modal -->
      <div id="warningModal" class="fixed inset-0 hidden items-center justify-center z-50">
        <div class="modal-backdrop absolute inset-0" onclick="closeWarningModal()"></div>
        <div class="relative w-11/12 md:w-96 bg-white rounded-lg shadow-lg overflow-hidden z-50">
          <div class="flex items-center justify-between px-4 py-3 border-b">
            <h3 class="text-sm font-semibold">Verification Warning</h3>
            <button class="p-2 rounded hover:bg-gray-50" onclick="closeWarningModal()"></button>
          </div>
          <div class="p-4">
            <div id="warningMessage" class="text-sm text-gray-600 mb-4"></div>
            <div class="flex justify-end gap-2">
              <button id="cancelBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Cancel</button>
              <button id="proceedBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Proceed</button>
            </div>
          </div>
        </div>
    </div>

    <div id="projectModal" class="fixed inset-0 hidden overflow-y-auto bg-black/50 backdrop-blur-sm" style="z-index:60" >
        <div class="bg-white rounded-3xl shadow-xl max-w-[60rem] w-full max-h-[90vh] overflow-y-auto border border-gray-300 mx-auto mt-[5vh]">
            
            <div class="bg-white px-6 py-4 flex justify-between items-center shrink-0 text-gray-800 border-b border-gray-200">
                <div>
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <svg class="w-6 h-6" viewBox="0 0 512 512" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>project</title>
                            <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g id="Combined-Shape" fill="currentColor" transform="translate(64.000000, 34.346667)">
                            <path d="M192,7.10542736e-15 L384,110.851252 L384,332.553755 L192,443.405007 L1.42108547e-14,332.553755 L1.42108547e-14,110.851252 L192,7.10542736e-15 Z M42.666,157.654 L42.6666667,307.920144 L170.666,381.82 L170.666,231.555 L42.666,157.654 Z M341.333,157.655 L213.333,231.555 L213.333,381.82 L341.333333,307.920144 L341.333,157.655 Z M192,49.267223 L66.1333333,121.936377 L192,194.605531 L317.866667,121.936377 L192,49.267223 Z">
                            </path></g></g></svg>
                        Export to Project
                    </h3>
                    <p class="text-gray-600 text-sm">Review client details (updates database) and set up tasks.</p>
                </div>
                <button onclick="closeProjectModal()" class="hover:bg-gray-100 rounded-full p-1"> 
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex flex-1 overflow-hidden">
                
                <div class="w-1/3 border-r border-gray-200 p-6 overflow-y-auto">
                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4 border-b pb-2">1. Edit Client Info</h4>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="block text-xs font-semibold text-gray-800 mb-1">Company Name</label>
                            <input type="text" id="edit_company" oninput="autoUpdateProjectName()"
                                    class="block w-full border-gray-300 rounded border px-3 py-2 text-sm focus:ring-gray-600 focus:border-gray-600">
                        </div>
    
                        <div>
                            <label class="block text-xs font-semibold text-gray-800 mb-1">Email Address</label>
                            <input type="text" id="edit_email" 
                                    class="block w-full border-gray-300 rounded border px-3 py-2 text-sm focus:ring-gray-600 focus:border-gray-600">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-semibold text-gray-800 mb-1">Phone Number</label>
                            <input type="text" id="edit_phone" 
                                    class="block w-full border-gray-300 rounded border px-3 py-2 text-sm focus:ring-gray-600 focus:border-gray-600">
                        </div>
                        
                        <div class="border-t border-gray-200 my-4"></div>
                        
                        <div class="bg-gray-100 p-3 rounded border border-gray-200">
                            <label class="block text-xs font-bold text-gray-800 mb-1">Project Name</label>
                            <input type="text" id="edit_project_name" 
                                    class="block w-full border-gray-300 rounded border px-3 py-2 text-sm focus:ring-gray-600 focus:border-gray-600 font-medium text-gray-800">
                        </div>
                        
                        
                    </div>
                </div>
                
                <div class="w-2/3 p-6 bg-white overflow-y-auto flex flex-col">
                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4 border-b pb-2">2. Select Tasks</h4>
                    
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-1 relative">
                            <select id="templateSelect" onchange="handleTemplateChange()" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-gray-600 focus:border-gray-600 sm:text-sm rounded-md border bg-gray-50 text-gray-800">
                                <option value="">-- Select Service Template --</option>
                            </select>
                            <div id="templateSpinner" class="absolute right-8 top-2.5 hidden">
                                <svg class="animate-spin h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-1 border border-gray-200 rounded-lg flex flex-col overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b flex justify-between items-center">
                            <span class="text-xs font-bold text-gray-800">TASK LIST</span>
                        </div>
                        
                        <div id="templateTasksContainer" class="p-4 overflow-y-auto space-y-2 flex-1">
                            <p class="text-gray-400 text-sm italic text-center mt-10">Select a template to load tasks...</p>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-xs font-semibold text-gray-800 mb-2">Add Custom Tasks</label>
                        <div class="flex gap-2">
                            <input type="text" id="newCustomTask" placeholder="Type task and press Enter" 
                                    class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:ring-gray-600 focus:border-gray-600"
                                    onkeypress="if(event.key === 'Enter') addCustomTask()">
                            <button onclick="addCustomTask()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm font-medium hover:bg-gray-700">Add</button>
                        </div>
                        <ul id="customTasksList" class="mt-2 flex flex-wrap gap-2"></ul>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-800 mb-1">Consultation Notes</label>
                        <textarea id="edit_notes" rows="3" class="block w-full border-gray-300 rounded border px-3 py-2 text-sm focus:ring-gray-600 focus:border-gray-600"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="bg-white px-6 py-4 border-t border-gray-200 flex justify-end gap-3 shrink-0">
                <button onclick="closeProjectModal()" class="px-4 py-2 border border-gray-300 rounded shadow-sm text-sm font-medium text-gray-800 hover:bg-gray-100">Cancel</button>
                <button id="submitProjectBtn" onclick="submitProjectCreation()" class="px-6 py-2 bg-gray-800 text-white rounded shadow-sm text-sm font-medium hover:bg-gray-700 flex items-center">
                    Create Project & Save Changes
                </button>
            </div>
        </div>
    </div>


    <div id="project-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" onclick="closeProjModal()"></div>
    
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                
                <div class="relative transform overflow-hidden bg-white text-left shadow-2xl min-h-[40rem] transition-all sm:my-8 sm:w-full sm:max-w-5xl rounded-2xl border border-gray-200">
                    
                    <div class="bg-white px-6 py-5 border-b border-gray-100 flex justify-between items-start">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900 tracking-tight" id="modal-title">Project Title</h3>
                            <p class="text-xs font-mono text-gray-400 mt-1" id="modal-id">ID: ---</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span id="header-status-badge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                                Loading...
                            </span>
                            <button type="button" class="text-gray-400 hover:text-gray-900 transition-colors p-1" onclick="closeProjModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
    
                    <div class="bg-gray-50/50 px-6 py-4 border-b border-gray-100">
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700">Overall Progress</span>
                            <span class="text-sm font-bold text-gray-900" id="modal-progress-text">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                            <div id="modal-progress-bar" class="bg-gray-800 h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
    
                    <div class="flex flex-col lg:flex-row">
                        
                        <div class="w-full lg:w-1/3 border-r border-gray-100 p-6 bg-white">
                            <h4 class="text-xs font-bold text-gray-900 uppercase tracking-widest mb-4">Project Details</h4>
                            
                            <div class="mb-6">
                                <p class="text-sm text-gray-600 leading-relaxed" id="modal-notes">
                                    No description provided.
                                </p>
                            </div>
    
                            <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Project Status</label>
                                <div class="relative">
                                    <select id="project-status-selector" onchange="updateProjectStatus(document.getElementById('modal-id').innerText.replace('ID: ', ''), this.value, this)" class="block w-full appearance-none rounded-lg border border-gray-300 bg-white py-2 pl-3 pr-10 text-sm text-gray-900 focus:border-gray-900 cursor-pointer focus:outline-none focus:ring-1 focus:ring-gray-900 sm:text-sm">
                                        <option value="Active">Active</option>
                                        <option value="On Hold">On Hold</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Canceled">Canceled</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <div class="w-full lg:w-2/3 bg-gray-50/30 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-xs font-bold text-gray-900 uppercase tracking-widest">Tasks & Deliverables</h4>
                                <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded border border-gray-200">
                                    <span id="stat-total-tasks">0</span> Tasks
                                </span>
                            </div>
    
                            <div id="task-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                            </div>
                            <div id="task-pagination">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="scheduleConsultationModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full z-50 transition-opacity duration-300 ease-in-out">
        <div class="relative top-20 mx-auto max-w-lg p-6 border-t-4 border-gray-800 shadow-2xl rounded-2xl bg-white transform transition-all duration-300 ease-in-out scale-100 opacity-100">
            <div class="mt-2 text-center">
                <h3 class="text-2xl leading-7 font-extrabold text-gray-900 border-b pb-3 mb-5">
                    Schedule Consultation
                </h3>
    
                <div class="mt-4 px-3 py-3">
    
                    
                    <div class="mb-5 text-left">
                        <label for="consultantSelect" class="block text-sm font-semibold text-gray-800 mb-1">
                            Select Consultant and Tier
                        </label>
                        <select id="consultantSelect" name="consultantSelect" required
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-gray-800 text-gray-700 sm:text-base transition duration-150 ease-in-out">
                            <option value="" disabled selected>Loading consultants...</option>
                        </select>
                    </div>
                    
    
                    <div class="mb-6 text-left">
                        <label for="scheduleTime" class="block text-sm font-semibold text-gray-800 mb-1">
                            Date and Time
                        </label>
                        <input type="datetime-local" id="scheduleTime" name="scheduleTime" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-gray-800 text-gray-700 sm:text-base transition duration-150 ease-in-out">
                    </div>
    
                </div>
    
                <div class="items-center px-2 pt-4 border-t sm:flex sm:flex-row-reverse">
                    <button id="submitScheduleBtn"
                            class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-transparent shadow-md px-5 py-2 bg-gray-800 text-base font-medium text-white hover:bg-gray-700 focus:outline-none  sm:ml-4 sm:text-sm transition duration-150 ease-in-out">
                        Confirm Schedule
                    </button>
                    <button onclick="closeScheduleConsultationModal()"
                            class="mt-3 w-full sm:w-auto inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-5 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none  sm:mt-0 sm:text-sm transition duration-150 ease-in-out">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>

        async function updateProjectStatus(projectId, newStatus, selectElement) {
            selectElement.disabled = true; 
            
            try {
                const response = await fetch(`/projects/${projectId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
        
                if (response.ok) {
                    const result = await response.json();
                    showPopup("Status Updated");
                    updateHeaderBadge(result.status); 
                    
                } else {
                    const error = await response.json();
                    showPopup(`Failed to update project status`);

                    selectElement.value = oldStatus;
                    updateHeaderBadge(oldStatus);
                }
            } catch (error) {
               
                showPopup("An error occurred while updating the project status (Network Error).");

                selectElement.value = oldStatus;
                updateHeaderBadge(oldStatus);
        
            } finally {
                selectElement.disabled = false;
            }
        }
    
        

        async function fetchProjects() {
            try {
                const response = await fetch(`/projects`);
                const projects = await response.json();
                renderProjects(projects);
            } catch (error) {
                console.error("Error fetching projects:", error);
                document.getElementById('project-grid').innerHTML = `<div class="text-red-500">Error loading projects. Ensure backend is running.</div>`;
            }
        }


function renderProjects(projects) {
    const grid = document.getElementById('project-grid');
    // Circumference for the progress circle (40 * 3.14159)
    const circumference = 125.66; 

    const getProgressOffset = (percent) => {
        return (100 - percent) / 100 * circumference;
    };

    grid.innerHTML = projects.map(p => `
        <div class="bg-white overflow-hidden rounded-2xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200">
            <div class="px-5 py-5 sm:p-6">
 
                <div class="flex justify-between items-start mb-4">
                    <div>
                    <h3 class="text-xl mb-2 font-semibold text-gray-800 line-clamp-2" title="${p.name}">${p.name}</h3>
                    <span class="inline-flex items-center mb-2 mr-2 px-3 py-1 text-xs font-medium rounded-full ${getStatusColor(p.status)}">
                        ${p.status}
                    </span>
                    <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded border border-gray-300 shadow-sm">
                        <span id="stat-total-tasks" class="font-semibold text-gray-800">${p.total_tasks}</span>Tasks
                    </span>
                    
                    </div>                  
                    
                    <div class="relative w-16 h-16">
                            <svg class="w-full h-full transform -rotate-90" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg">
                                <circle
                                    class="text-gray-200"
                                    stroke-width="4"
                                    stroke="currentColor"
                                    fill="transparent"
                                    r="20"
                                    cx="22"
                                    cy="22"
                                />
                                <circle
                                    class="text-gray-800 transition-all duration-500 ease-out"
                                    stroke-width="4"
                                    stroke-dasharray="${circumference}"
                                    stroke-dashoffset="${getProgressOffset(p.progress_percent)}"
                                    stroke-linecap="round"
                                    stroke="currentColor"
                                    fill="transparent"
                                    r="20"
                                    cx="22"
                                    cy="22"
                                />
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-sm font-bold text-gray-800">
                                    ${p.progress_percent}%
                                </span>
                            </div>
                        </div>
                </div>
                
                <div class="text-[10x] text-gray-400 mb-1 h-12 overflow-hidden">
                    ${p.notes ? p.notes.substring(0, 70) + (p.notes.length > 70 ? '...' : '') : '<span class="italic text-gray-400">No notes provided.</span>'}
                </div>

                <div class="border-t border-gray-200 pt-4 mt-4 flex justify-between items-end">

                    <div class="flex items-center">
                    
                        <button onclick="openProjModal('${p.id}')" class="text-xs inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded hover:shadow-sm">
                            View
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}


        function applyTaskStatusStyle(selectElement, status) {
            // Clear existing status classes
            selectElement.classList.remove('text-green-700', 'border-green-300', 'bg-green-50');
                
            if (status === 'Completed') {
                // Style for completed tasks
                selectElement.classList.add('text-green-700', 'border-green-300', 'bg-green-50');
            } else {
                // Default style for other statuses
                selectElement.classList.add('text-gray-700', 'border-gray-300', 'bg-white');
            }
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Active': return 'bg-green-100 text-green-800';
                case 'On Hold': return 'bg-yellow-100 text-yellow-800';
                case 'Completed': return 'bg-blue-100 text-blue-800';
                case 'Canceled': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
    
        function setStatusBadge(elementId, status) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerText = status;
                // Clear existing color classes
                element.className = element.className.split(' ').filter(c => !c.startsWith('bg-') && !c.startsWith('text-')).join(' ');
                // Add new color classes
                element.classList.add(...getStatusColor(status).split(' '));
            }
        }

        fetchProjects();

    const SVGS = {
        upload: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>`,
        file: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5 mr-1.5 text-gray-400"><path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm2.25 8.5a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 3a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" /></svg>`,
        spinner: `<svg class="animate-spin h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`,
        check: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-green-600"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>`
    };

    async function openProjModal(projectId) {
        const modal = document.getElementById('project-modal');
        modal.classList.remove('hidden');
    
        // RESET PAGINATION for the new project
        currentTaskPage = 1; 
        allTasks = [];
    
        // Loading State
        document.getElementById('task-list').innerHTML = `
            <div class="flex flex-col items-center justify-center py-12">
                ${SVGS.spinner}
                <p class="text-sm text-gray-500 mt-3">Loading Tasks...</p>
            </div>`;
        
        // CLEAR Pagination div explicitly to hide old buttons while loading
        const pagContainer = document.getElementById('task-pagination');
        if(pagContainer) pagContainer.innerHTML = '';
    
        try {
            const response = await fetch(`/projects/${projectId}`);
            const project = await response.json();
            populateModal(project);
        } catch (e) {
            console.error(e);
            alert("Failed to load project.");
            closeProjModal();
        }
    }

function closeProjModal() {
    document.getElementById('project-modal').classList.add('hidden');
    fetchProjects(); // Refresh main dashboard
}

function populateModal(project) {
    document.getElementById('modal-title').innerText = project.name;
    document.getElementById('modal-id').innerText = `ID: ${project.id}`;
    document.getElementById('modal-notes').innerText = project.notes || "No description.";
    document.getElementById('stat-total-tasks').innerText = project.tasks.length;
    document.getElementById('project-status-selector').value = project.status;
    
    updateHeaderBadge(project.status);
    updateProgressUI(project.progress_percent);
    renderTasks(project.tasks);
}

let currentTaskPage = 1; 
const tasksPerPage = 3;
let allTasks = []; 
function renderTasks(tasks) {
    const container = document.getElementById('task-list');
    const paginationContainer = document.getElementById('task-pagination');

    // 1. Create a SAFE COPY to avoid mutation issues during sort
    // 2. Update global allTasks
    allTasks = [...tasks]; 

    if (!tasks || tasks.length === 0) {
        container.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm border border-dashed border-gray-200 rounded-xl bg-white">No tasks yet.</div>`;
        if(paginationContainer) paginationContainer.innerHTML = ''; 
        return;
    }

    // Sort the COPY, not the original reference
    const sortedTasks = allTasks.sort((a, b) => a.sequence_number - b.sequence_number);

    // --- Pagination Logic ---
    const totalPages = Math.ceil(sortedTasks.length / tasksPerPage);
    
    // Safety check: If current page is somehow out of bounds, reset it
    if (currentTaskPage > totalPages) {
        currentTaskPage = 1;
    }
    
    const startIndex = (currentTaskPage - 1) * tasksPerPage;
    const endIndex = startIndex + tasksPerPage;
    const tasksToDisplay = sortedTasks.slice(startIndex, endIndex);

    // --- Render Tasks ---
    container.innerHTML = tasksToDisplay.map(task => `
        <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm relative" id="task-card-${task.id}">
            <div class="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-mono font-medium text-gray-400">${task.sequence_number}</span>
                        <h5 class="text-base font-bold text-gray-900 truncate">${task.title}</h5>
                        ${task.status === 'Completed' ? SVGS.check : ''}
                    </div>
                    <p class="text-sm text-gray-500 line-clamp-2 leading-relaxed">${task.details || ''}</p>
                    <div class="mt-3 flex flex-wrap gap-2" id="files-container-${task.id}">
                        ${renderFiles(task.files)}
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2 w-full sm:w-auto min-w-[160px]">
                    <div class="relative">
                         <select onchange="updateTaskStatus('${task.id}', this.value, this)"
                            data-old-status="${task.status}"
                            class="block w-full cursor-pointer appearance-none rounded-lg border border-gray-300 min-w-[160px] bg-white py-2 pl-3 pr-10 text-sm text-gray-900 focus:outline-none sm:text-sm">
                            <option value="Pending" ${task.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                    <div class="relative w-full">
                        <label class="flex items-center justify-center w-full px-3 py-1.5 text-xs font-medium text-gray-600 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 hover:border-gray-300 transition-colors shadow-sm">
                            ${SVGS.upload} Attach
                            <input type="file" class="hidden" onchange="uploadFile('${task.id}', this)">
                        </label>
                        <div id="spinner-${task.id}" class="absolute inset-0 flex items-center justify-center bg-white/90 rounded-lg hidden">
                            ${SVGS.spinner}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    rendertaskPaginationControls(totalPages);
    container.scrollTop = 0;
}


function changeTaskPage(newPage) {
    const pageNum = parseInt(newPage); 
    const totalPages = Math.ceil(allTasks.length / tasksPerPage); 

    if (pageNum >= 1 && pageNum <= totalPages) {
        currentTaskPage = pageNum; 
        renderTasks(allTasks); 
    } else {
        console.warn("Invalid page requested");
    }
}

 function rendertaskPaginationControls(totalPages) {
    const paginationContainer = document.getElementById('task-pagination');
    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }

    // Determine the disabled state based on the current page.
    const isPrevDisabled = currentTaskPage === 1;
    const isNextDisabled = currentTaskPage === totalPages;

    const prevDisabledClass = isPrevDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50';
    const nextDisabledClass = isNextDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50';

    paginationContainer.innerHTML = `
    <div class="flex justify-center items-center gap-2 mt-4">
        <button onclick="changeTaskPage(${currentTaskPage - 1})" 
                class="p-2 border border-gray-300 rounded-lg text-sm text-gray-700 ${prevDisabledClass}"
                ${isPrevDisabled ? 'onclick="return false;" style="pointer-events:none;"' : ''}>
            Previous
        </button>
        
        <span class="text-sm font-medium text-gray-700">Page ${currentTaskPage} of ${totalPages}</span>
        
        <button onclick="changeTaskPage(${currentTaskPage + 1})" 
                class="p-2 border border-gray-300 rounded-lg text-sm text-gray-700 ${nextDisabledClass}"
                ${isNextDisabled ? 'onclick="return false;" style="pointer-events:none;"' : ''}>
            Next
        </button>
    </div>
    `;
}
function renderFiles(files) {
    if (!files || files.length === 0) return '';
    return files.map(f => `
        <a href="${f.storage_path}" target="_blank" class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200 hover:text-gray-900 transition-colors truncate max-w-[150px]" title="${f.file_name}">
            ${SVGS.file} ${f.file_name}
        </a>
    `).join('');
}

// --- Logic Updates ---

async function updateTaskStatus(taskId, newStatus, selectElement) {
    const oldStatus = selectElement.getAttribute('data-old-status');
    selectElement.disabled = true; // Prevent double clicks

    try {
        const formData = new FormData();
        formData.append('status', newStatus);

        const response = await fetch(`/tasks/${taskId}/status`, {
            method: 'PATCH',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            
            // Update UI Logic
            updateProgressUI(result.new_progress);
            selectElement.setAttribute('data-old-status', newStatus);

        } else {
            throw new Error('Failed');
        }
    } catch (error) {
        console.error(error);
        selectElement.value = oldStatus; // Rollback
        alert("Failed to update status");
    } finally {
        selectElement.disabled = false;
    }
}

async function uploadFile(taskId, inputElement) {
    const file = inputElement.files[0];
    if (!file) return;

    const spinner = document.getElementById(`spinner-${taskId}`);
    spinner.classList.remove('hidden');

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch(`/tasks/${taskId}/files`, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const newFile = await response.json();
            // Append file
            const container = document.getElementById(`files-container-${taskId}`);
            container.innerHTML += renderFiles([newFile]);
        } else {
            alert("Upload failed");
        }
    } catch (error) {
        console.error(error);
        alert("Error uploading");
    } finally {
        spinner.classList.add('hidden');
        inputElement.value = '';
    }
}

function updateProgressUI(percent) {
    const safePercent = Math.min(100, Math.max(0, parseInt(percent) || 0));
    document.getElementById('modal-progress-text').innerText = `${safePercent}%`;
    document.getElementById('modal-progress-bar').style.width = `${safePercent}%`;
    
    // Strict Gray-800 for progress
    const bar = document.getElementById('modal-progress-bar');
    bar.className = `h-2.5 rounded-full transition-all duration-500 ease-out ${safePercent === 100 ? 'bg-gray-900' : 'bg-gray-800'}`;
}

function updateHeaderBadge(status) {
    const badge = document.getElementById('header-status-badge');
    badge.innerText = status;
    
    // Reset classes
    badge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ";
    
    switch(status) {
        case 'Completed':
            badge.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
            break;
        case 'Active':
            badge.classList.add('bg-gray-900', 'text-white', 'border-gray-900');
            break;
        default:
            badge.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-200');
    }
}
</script>


      

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabPanels = document.querySelectorAll('.tab-panel');

            // Tab switching
            tabLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    const targetPanel = document.getElementById(tabId + '-tab');

                    // Remove active from all links and panels
                    tabLinks.forEach(l => l.classList.remove('bg-gray-100', 'dark:bg-gray-700/50', 'text-gray-800', 'dark:text-white', 'font-semibold'));
                    tabPanels.forEach(p => p.classList.add('hidden'));

                    // Add active to clicked
                    this.classList.add('bg-gray-100', 'dark:bg-gray-700/50', 'text-gray-800', 'dark:text-white', 'font-semibold');
                    if (targetPanel) {
                        targetPanel.classList.remove('hidden');
                    }
                });
            });

            

            overlay.addEventListener('click', function() {
                overlay.classList.add('invisible', 'bg-opacity-0');
                overlay.style.pointerEvents = 'none';
            });


        });

        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggle-btn');
            const sidebar = document.getElementById('sidebar');
            const icon = toggleBtn.querySelector('svg path');
        
            toggleBtn.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                if (sidebar.classList.contains('collapsed')) {
                    icon.setAttribute('d', 'M9 5l7 7-7 7'); // Chevron-right path
                } else {
                    icon.setAttribute('d', 'M15 19l-7-7 7-7'); // Chevron-left path
                }
            });
        });
    </script>
    <script src="/static/session.js"></script>
    <script src="/static/leads.js"></script>
</body>
</html>